
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codex Ignis ðŸ“œ The Omni-Archive</title>

    <!-- Libs: Marked, DOMPurify & FontAwesome -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Fira+Code&display=swap" rel="stylesheet">

    <style>
        
        /* --- Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code&display=swap');

        :root {
            /* === Color Palette - Light Mode (Refined) === */
            --primary-light: #665df5;   /* Adjusted vibrant purple */
            --secondary-light: #00d5c3; /* Brighter teal accent */
            --accent-light: #ff8c42;    /* Orange accent for contrast */
            --bg-light: #f9f9fb;        /* Even lighter page bg */
            --sidebar-bg-light: rgba(255, 255, 255, 0.65);
            --main-bg-light: #ffffff;
            --card-bg-light: #ffffff;
            --text-main-light: #1b1b1f;
            --text-secondary-light: #818186;
            --border-light: #e0e0e5;
            --shadow-color-light: rgba(94, 92, 245, 0.1); /* Primary color based shadow */
            --user-bg-light: linear-gradient(135deg, #7168ff, var(--primary-light));
            --user-text-light: #ffffff;
            --ai-bg-light: #f0f1f5;     /* Slightly distinct AI bubble */
            --ai-text-light: #48484d;
            --code-bg-light: #edf1f5;
            --code-text-light: #3f516d;
            --code-border-light: #dce1e8;
            --scrollbar-thumb-light: #bfc0c5;
            --scrollbar-track-light: rgba(240, 240, 240, 0.5);
            --backdrop-blur-light: blur(22px) saturate(190%);
            --category-header-bg-light: rgba(230, 230, 235, 0.5);
            --modal-bg-light: rgba(255, 255, 255, 0.8);
            --input-bg-light: #f5f5f7;

            /* === Color Palette - Dark Mode (Refined) === */
            --primary-dark: #7e78fa;   /* Softer purple for dark */
            --secondary-dark: #3eecec; /* Lighter teal */
            --accent-dark: #ffa970;     /* Lighter orange */
            --bg-dark: #0a0a0b;         /* Deep near black */
            --sidebar-bg-dark: rgba(25, 25, 28, 0.7);
            --main-bg-dark: #161618;
            --card-bg-dark: #212124;
            --text-main-dark: #fcfcfc;
            --text-secondary-dark: #9a9aa0;
            --border-dark: #38383c;
            --shadow-color-dark: rgba(0, 0, 0, 0.25);
            --user-bg-dark: linear-gradient(135deg, var(--primary-dark), #938eff);
            --user-text-dark: #ffffff;
            --ai-bg-dark: #313134;
            --ai-text-dark: #dadadf;
            --code-bg-dark: #242833;
            --code-text-dark: #a9b8d0;
            --code-border-dark: #3a3f4d;
            --scrollbar-thumb-dark: #4d4d52;
            --scrollbar-track-dark: rgba(40, 40, 43, 0.5);
            --backdrop-blur-dark: blur(25px) saturate(170%);
            --category-header-bg-dark: rgba(50, 50, 55, 0.5);
            --modal-bg-dark: rgba(0, 0, 0, 0.75);
            --input-bg-dark: #313134;


            /* --- Structure, Animation, Defaults (Refined) --- */
            --font-family: 'Cairo', sans-serif;
            --font-code: 'Fira Code', Consolas, monospace;
            --radius-lg: 18px; --radius-md: 14px; --radius-sm: 10px;
            --sidebar-width: 320px;
            --transition-fast: 0.2s ease-out;
            --transition-med: 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.5s ease-in-out;
            --shadow-color: var(--shadow-color-light);
            --shadow-1: 0 3px 6px var(--shadow-color);
            --shadow-2: 0 7px 20px var(--shadow-color);
            --shadow-3: 0 12px 35px var(--shadow-color);

             /* --- Assign Defaults (Light Theme) --- */
             --primary: var(--primary-light); --secondary: var(--secondary-light); --accent: var(--accent-light); --bg: var(--bg-light);
             --sidebar-bg: var(--sidebar-bg-light); --main-bg: var(--main-bg-light); --card-bg: var(--card-bg-light); --text-main: var(--text-main-light);
             --text-secondary: var(--text-secondary-light); --border: var(--border-light); --user-bg: var(--user-bg-light); --user-text: var(--user-text-light);
             --ai-bg: var(--ai-bg-light); --ai-text: var(--ai-text-light); --code-bg: var(--code-bg-light); --code-text: var(--code-text-light);
             --code-border: var(--code-border-light); --scrollbar-thumb: var(--scrollbar-thumb-light); --scrollbar-track: var(--scrollbar-track-light);
             --backdrop-blur: var(--backdrop-blur-light); --category-header-bg: var(--category-header-bg-light); --modal-bg: var(--modal-bg-light); --input-bg: var(--input-bg-light);
        }

         body.dark-mode {
             --primary: var(--primary-dark); --secondary: var(--secondary-dark); --accent: var(--accent-dark); --bg: var(--bg-dark);
             --sidebar-bg: var(--sidebar-bg-dark); --main-bg: var(--main-bg-dark); --card-bg: var(--card-bg-dark); --text-main: var(--text-main-dark);
             --text-secondary: var(--text-secondary-dark); --border: var(--border-dark); --shadow-color: var(--shadow-color-dark); --user-bg: var(--user-bg-dark);
             --user-text: var(--user-text-dark); --ai-bg: var(--ai-bg-dark); --ai-text: var(--ai-text-dark); --code-bg: var(--code-bg-dark);
             --code-text: var(--code-text-dark); --code-border: var(--code-border-dark); --scrollbar-thumb: var(--scrollbar-thumb-dark);
             --scrollbar-track: var(--scrollbar-track-dark); --backdrop-blur: var(--backdrop-blur-dark); --category-header-bg: var(--category-header-bg-dark); --modal-bg: var(--modal-bg-dark); --input-bg: var(--input-bg-dark);
         }

        /* === Base & Background Animation === */
         * { box-sizing: border-box; margin: 0; padding: 0; }
         html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
         html, body { height: 100%; overflow: hidden; }
          @keyframes animatedBackground { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
         button { font-family: inherit; cursor: pointer; border: none; background: none; padding: 0; display: inline-flex; align-items: center; justify-content: center; color: inherit; }
         svg { width: 1em; height: 1em; fill: currentColor; vertical-align: -0.15em; }
         h1,h2,h3,h4,h5,h6 { line-height: 1.3; font-weight: 800; margin-bottom: 0.6em; }
         ::selection { background-color: var(--primary); color: var(--user-text); }

        /* === Scrollbars === */
        ::-webkit-scrollbar { width: 12px; height: 12px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: var(--radius-lg); border: 4px solid transparent; background-clip: content-box; transition: background-color var(--transition-fast), border-width var(--transition-fast); }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); border-width: 3px; }
        * { scrollbar-width: thin; scrollbar-color: var(--scrollbar-thumb) transparent; }

        /* === Sidebar (Glassmorphism & Enhanced Hover) === */
        #sidebar {
            width: var(--sidebar-width); height: 100vh; background-color: var(--sidebar-bg); -webkit-backdrop-filter: var(--backdrop-blur);
            backdrop-filter: var(--backdrop-blur); border-left: 1px solid var(--border); display: flex; flex-direction: column;
            flex-shrink: 0; box-shadow: var(--shadow-2); transition: all var(--transition-med);
            position: relative; z-index: 1001;
        }
        body.dark-mode #sidebar { box-shadow: 5px 0 40px var(--shadow-color); border-color: rgba(255, 255, 255, 0.1);}
        .sidebar-header { padding: 28px; border-bottom: 1px solid var(--border); flex-shrink: 0; display: flex; flex-direction: column; gap: 15px; transition: border-color var(--transition-med); background-color: rgba(255,255,255,0.05); }
        body.dark-mode .sidebar-header { background-color: rgba(0,0,0,0.15); border-color: rgba(255, 255, 255, 0.1);}
        .sidebar-header-top { display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h2 { margin: 0; color: var(--text-main); font-size: 1.8em; font-weight: 900; letter-spacing: -0.7px; }
        .sidebar-header h2 span { color: var(--primary); display: inline-block; transform: scale(1.2); animation: emojiWobble 2s infinite ease-in-out; margin-right: 5px; }
        @keyframes emojiWobble { 0%, 100% { transform: rotate(-8deg) scale(1.2); } 50% { transform: rotate(8deg) scale(1.2); } }

        #darkModeToggle { font-size: 1.4em; padding: 8px; border-radius: 50%; color: var(--text-secondary); transition: all var(--transition-fast); position: relative; overflow: hidden; }
        #darkModeToggle:hover { background-color: rgba(128,128,128,0.1); color: var(--primary); transform: scale(1.15); }
        #darkModeToggle::before { content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; background: rgba(var(--primary-rgb, 0, 0, 0), 0.15); border-radius: 50%; transform: translate(-50%, -50%); transition: width 0.3s ease, height 0.3s ease; }
        #darkModeToggle:active::before { width: 150%; height: 150%; }

        .file-input-label, #downloadButton {
             display: flex; align-items: center; justify-content: center; gap: 10px; padding: 12px 18px; color: white; border-radius: var(--radius-md); font-weight: 700; text-align: center; transition: all var(--transition-fast); font-size: 1.0em; box-shadow: var(--shadow-1); cursor: pointer;
             background-image: linear-gradient(60deg, var(--primary), var(--secondary));
        }
        #fileInput { display: none; }
        .file-input-label:hover, #downloadButton:hover { transform: translateY(-3px) scale(1.03); box-shadow: var(--shadow-2); filter: brightness(1.1); }
        .file-input-label:active, #downloadButton:active { transform: translateY(-1px) scale(0.99); filter: brightness(0.95); box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);}


        /* Search Input Styling */
         #search-container { position: relative; margin-top: 5px; }
         #search-icon { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); color: var(--text-secondary); transition: color var(--transition-fast); pointer-events: none; font-size: 1.2em; }
         #searchInput { width: 100%; background-color: var(--input-bg); color: var(--text-main); border: 2px solid var(--code-border); border-radius: var(--radius-md); padding: 12px 45px 12px 20px; font-family: var(--font-family); font-size: 1em; font-weight: 600; outline: none; transition: all var(--transition-med); box-shadow: inset 0 2px 4px rgba(0,0,0,0.02); }
         #searchInput::placeholder { color: var(--text-secondary); opacity: 0.8; font-weight: 500;}
         #searchInput:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(102, 93, 245, 0.2); background-color: var(--card-bg); }
         #searchInput:focus ~ #search-icon { color: var(--primary); }

        #statusMessage { color: var(--text-secondary); font-size: 0.95em; min-height: 2em; text-align: center; transition: all var(--transition-med); display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 600; opacity: 0.9; }
         #statusMessage .loader { width: 12px; height: 12px; animation: pulseLoader 1.5s infinite ease-in-out; background-color: var(--primary); border-radius: 50%; display: inline-block; border: none; }
         @keyframes pulseLoader { 0%, 100% { transform: scale(0.8); opacity: 0.6; } 50% { transform: scale(1.1); opacity: 1; } }

        #conversation-list-container { flex-grow: 1; overflow-y: auto; padding: 15px 10px; }
        
        /* --- ðŸŒŸ NEW: Category Styling --- */
        .category-header {
            display: flex; align-items: center; justify-content: space-between; padding: 12px 18px; margin: 8px 5px 4px; cursor: pointer; border-radius: var(--radius-md);
            background-color: var(--category-header-bg); transition: all var(--transition-fast); font-weight: 800; font-size: 1.1em; color: var(--text-main); border: 1px solid var(--border);
        }
        .category-header:hover { background-color: var(--primary); color: white; border-color: transparent; box-shadow: var(--shadow-1); }
        .category-header .category-title { display: flex; align-items: center; gap: 10px; }
        .category-header .category-count { font-size: 0.85em; font-weight: 600; opacity: 0.7; }
        .category-header:hover .category-count { color: rgba(255,255,255,0.8); }
        .category-toggle-icon { transition: transform var(--transition-med); display: flex; align-items: center; } /* Added display: flex */
        .category-header.collapsed .category-toggle-icon { transform: rotate(-90deg); }
        .conversation-group { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 6px; overflow: hidden; transition: max-height var(--transition-med); }
        .conversation-group.collapsed { max-height: 0 !important; } /* Use important to override dynamic height */
        
         #conversation-list-container li {
             padding: 15px 22px; margin: 0 5px; cursor: pointer; border-radius: var(--radius-md);
             transition: all 0.2s ease, max-height 0.4s ease-out, opacity 0.4s ease-out;
             white-space: nowrap;   text-overflow: ellipsis; font-size: 1.05em;
             font-weight: 700; position: relative; color: var(--text-secondary); border: 1px solid transparent;
             max-height: 100px; opacity: 1;
         }
         #conversation-list-container li.hidden { max-height: 0; opacity: 0; padding-top: 0; padding-bottom: 0; margin-top: 0; margin-bottom: 0; pointer-events: none; border-color: transparent; }
          #conversation-list-container li::before {
               content: ''; position: absolute; top: 0; right: 0; height: 100%; width: 4px;
               background-color: var(--primary); transform: scaleY(0);
               transition: transform 0.3s cubic-bezier(0.77, 0, 0.175, 1);
               transform-origin: bottom; border-radius: 0 4px 4px 0;
           }
         #conversation-list-container li:hover::before { transform: scaleY(1); transform-origin: top; }
         #conversation-list-container li:hover { background-color: rgba(128,128,128,0.05); color: var(--text-main); border-color: rgba(128,128,128,0.08); transform: translateX(-2px); }
         body.dark-mode #conversation-list-container li:hover { background-color: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.08);}
         #conversation-list-container li.active {
            background-image: linear-gradient(95deg, var(--primary) 0%, var(--secondary) 100%); color: white;
            font-weight: 800; box-shadow: var(--shadow-1); transform: none; border-color: transparent;
         }
         #conversation-list-container li.active::before { transform: scaleY(1); }
         #conversation-list-container li.active:hover { transform: none; box-shadow: var(--shadow-2); filter: brightness(1.05); }

        /* === Main Content Area === */
        #main-content { flex-grow: 1; height: 100vh; background-color: var(--main-bg); display: flex; flex-direction: column; overflow: hidden; transition: background-color var(--transition-med); border-top-left-radius: var(--radius-lg); border-bottom-left-radius: var(--radius-lg); }
        #conversation-display-header {
             padding: 22px 35px; background-color: var(--card-bg); border-bottom: 1px solid var(--border); box-shadow: var(--shadow-1); flex-shrink: 0; z-index: 1000;
             display: flex; align-items: center; gap: 18px; transition: all var(--transition-med);
             position: relative; /* For category edit popup positioning */
        }
        #sidebarToggle { display: none; font-size: 1.7em; padding: 9px; border-radius: 50%; color: var(--text-secondary); transition: all var(--transition-fast); }
         #sidebarToggle:hover { color: var(--primary); background-color: rgba(128,128,128,0.08); transform: scale(1.1) rotate(-5deg); }
        #conversation-display-header h3 { margin: 0; font-size: 1.9em; font-weight: 900; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; transition: color var(--transition-med); letter-spacing: -0.5px; }
        
        /* --- ðŸŒŸ NEW: Category Display & Edit Button --- */
        #currentCategory {
            font-size: 1.0em; color: var(--text-secondary); font-weight: 600; background-color: var(--ai-bg); padding: 8px 15px;
            border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-fast);
            display: flex; align-items: center; gap: 8px; flex-shrink: 0;
            white-space: nowrap;
        }
        #currentCategory:hover { background-color: var(--primary); color: white; transform: translateY(-2px); box-shadow: var(--shadow-1); }
        #currentCategory svg { transition: transform var(--transition-fast); }
        #currentCategory:hover svg { transform: rotate(15deg); }

         #conversation-display-messages { flex-grow: 1; overflow-y: auto; padding: 35px 40px; display: flex; flex-direction: column; gap: 28px; }

        /* === Skeleton Loading Placeholders === */
         .skeleton-message { display: flex; gap: 15px; width: 80%; opacity: 0; animation: skeletonFadeIn 0.5s ease forwards; }
         @keyframes skeletonFadeIn { to { opacity: 1; } }
         .skeleton-message.user-skel { align-self: flex-end; flex-direction: row-reverse; }
         .skeleton-message.ai-skel { align-self: flex-start; }
         .skeleton-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: var(--ai-bg); flex-shrink: 0; }
         .skeleton-content { flex-grow: 1; display: flex; flex-direction: column; gap: 8px; }
         .skeleton-line { height: 14px; background-color: var(--ai-bg); border-radius: var(--radius-sm); }
         .skeleton-line.short { width: 60%; } .skeleton-line.medium { width: 85%; }
         .skeleton-avatar, .skeleton-line { background-image: linear-gradient(90deg, var(--ai-bg) 25%, var(--card-bg) 50%, var(--ai-bg) 75%); background-size: 200% 100%; animation: skeletonShimmer 1.8s infinite linear; }
        body.dark-mode .skeleton-avatar, body.dark-mode .skeleton-line { background-image: linear-gradient(90deg, var(--ai-bg) 25%, var(--card-bg) 50%, var(--ai-bg) 75%); }
         @keyframes skeletonShimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

         #welcome-screen { text-align: center; color: var(--text-secondary); margin: auto; font-size: 1.3em; font-weight: 600; max-width: 450px; line-height: 1.8; transition: all var(--transition-med); display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;}
         #welcome-screen .welcome-icon { font-size: 3.5em; margin-bottom: 20px; opacity: 0.6; animation: spinAndFloat 8s infinite ease-in-out;}
         @keyframes spinAndFloat { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-10px) rotate(10deg); }}
         #welcome-screen h1 { font-size: 2.2em; color: var(--text-main); font-weight: 900; margin-bottom: 10px;}
         #welcome-screen p { font-size: 1.1em; line-height: 1.7; max-width: 400px; }


         /* === Message Styling - Refined Animation === */
         .message { padding: 16px 24px; border-radius: var(--radius-lg); max-width: 80%; word-wrap: break-word; position: relative; font-size: 1.08em; border: 1px solid transparent; opacity: 0; animation: messageReveal 0.6s var(--transition-med) forwards; box-shadow: var(--shadow-1); transition: all var(--transition-fast); }
         @keyframes messageReveal { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
         .message:hover { box-shadow: var(--shadow-2); transform: translateY(-3px); }
        .message .author { display: block; font-size: 0.85em; font-weight: 800; margin-bottom: 8px; text-transform: capitalize; letter-spacing: 0.5px; opacity: 0; transform: translateY(5px); animation: authorFadeIn 0.4s 0.1s ease forwards; }
         @keyframes authorFadeIn { to { opacity: 0.85; transform: translateY(0); }}
         
        .user-message { background: var(--user-bg); color: var(--user-text); align-self: flex-end; margin-right: auto; border-bottom-left-radius: var(--radius-sm); border-color: transparent; }
         .ai-message { background: var(--ai-bg); color: var(--ai-text); align-self: flex-start; margin-left: auto; border-bottom-right-radius: var(--radius-sm); border-color: var(--border); }
         .user-message .author { color: rgba(255,255,255,0.85); } .ai-message .author { color: var(--text-secondary); }

        /* === Markdown Styling - Final Touches === */
         .message-content { margin-top: 10px; line-height: 1.8; } .message-content > *:first-child { margin-top: 0; } .message-content > *:last-child { margin-bottom: 0; }
        @keyframes contentPartReveal { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .ai-message .message-content > * { opacity: 0; animation: contentPartReveal 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        .message-content p { margin-bottom: 1em; } .message-content > p:only-child { margin-bottom: 0; }
        .message-content h1, .message-content h2, .message-content h3 { margin: 1.8em 0 1.1em 0; padding-bottom: 0.4em; border-bottom: 2px solid var(--border); font-weight: 900; }
        .message-content h1 { font-size: 1.9em; color: var(--primary); } .message-content h2 { font-size: 1.6em; } .message-content h3 { font-size: 1.4em; }
         .message-content ul, .message-content ol { margin-bottom: 1.1em; padding-right: 35px; }
        .message-content li { margin-bottom: 0.7em; } .message-content li::marker { color: var(--primary); font-weight: bold; font-size: 1.2em; }
        .message-content blockquote { border-right: 6px solid var(--primary); background-color: rgba(128,128,128,0.05); padding: 16px 28px 16px 12px; margin: 1.6em 0; color: var(--text-secondary); font-style: italic; border-radius: 0 var(--radius-md) var(--radius-md) 0; border-left: none; box-shadow: inset 5px 0 10px rgba(0,0,0,0.03); }
         body.dark-mode .message-content blockquote { background-color: rgba(255,255,255,0.02); box-shadow: inset 5px 0 10px rgba(255,255,255,0.02); }
        .message-content blockquote p { margin-bottom: 0.6em; font-style: normal; } .message-content blockquote > *:last-child { margin-bottom: 0; }
         .message-content pre { position: relative; background-color: var(--code-bg); border: 1px solid var(--code-border); border-radius: var(--radius-md); padding: 20px 22px; margin: 1.6em 0; overflow-x: auto; font-family: var(--font-code); font-size: 1em; direction: ltr; text-align: left; color: var(--code-text); line-height: 1.65; box-shadow: var(--shadow-1); }
         .message-content code { /* Inline */ font-family: var(--font-code); font-size: 0.9em; background-color: var(--code-bg); padding: 0.35em 0.8em; border-radius: var(--radius-sm); border: 1px solid var(--code-border); color: var(--accent); }
         .message-content pre code { background: none; padding: 0; border: none; border-radius: 0; color: inherit; font-size: inherit; box-shadow: none; }
        
         .code-copy-button { position: absolute; top: 12px; left: 12px; background-color: rgba(128, 128, 128, 0.1); color: var(--text-secondary); border-radius: var(--radius-sm); padding: 6px 10px; font-size: 0.85em; font-weight: 700; border: 1px solid var(--code-border); cursor: pointer; opacity: 0; visibility: hidden; transform: translateY(-5px); transition: all var(--transition-fast); backdrop-filter: blur(5px); }
         .message-content pre:hover .code-copy-button { opacity: 1; visibility: visible; transform: translateY(0); }
         .code-copy-button:hover { background-color: var(--primary); color: white; border-color: transparent; }
         .code-copy-button.copied { background-color: var(--secondary); color: white; border-color: transparent; }
         .message-content table { border-collapse: separate; border-spacing: 0; margin: 2em 0; width: 100%; border: 1px solid var(--border); border-radius: var(--radius-md); box-shadow: var(--shadow-1); overflow: hidden; }
         .message-content th, .message-content td { padding: 15px 20px; text-align: right; border-bottom: 1px solid var(--border); }
        .message-content td { border-right: 1px solid var(--border); background-color: var(--card-bg); transition: background-color 0.1s ease; }
        .message-content td:first-child { border-right: none; }
         .message-content th { background-color: var(--ai-bg); font-weight: 800; color: var(--text-secondary); text-transform: uppercase; font-size: 0.9em; border-bottom-width: 2px; }
        .message-content tr:last-child td { border-bottom: none; }
        .message-content tr:hover td { background-color: rgba(128,128,128,0.04); } body.dark-mode .message-content tr:hover td { background-color: rgba(255,255,255,0.04); }
        .message-content a { color: var(--primary); text-decoration: none; font-weight: 700; border-bottom: 2px dotted currentColor; transition: color var(--transition-fast), border-color 0.2s ease; padding-bottom: 2px; }
         .message-content a:hover { color: var(--secondary); border-bottom-style: solid; border-bottom-color: var(--secondary); }
         .message-content hr { border: none; height: 1px; background-image: linear-gradient(to left, transparent, var(--border), transparent); margin: 3em 0; opacity: 0.7; }

        /* --- ðŸŒŸ NEW: Category Edit Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4);
            -webkit-backdrop-filter: blur(5px); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center; z-index: 2000;
            opacity: 0; visibility: hidden; transition: opacity var(--transition-med), visibility var(--transition-med);
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: var(--card-bg); padding: 30px; border-radius: var(--radius-lg); box-shadow: var(--shadow-3);
            width: 90%; max-width: 500px; transform: translateY(-20px); transition: transform var(--transition-med);
            border: 1px solid var(--border); position: relative;
        }
        .modal-overlay.visible .modal-content { transform: translateY(0); }
        .modal-content h3 { font-size: 1.6em; margin-top: 0; margin-bottom: 20px; color: var(--primary); }
        .modal-category-input {
            width: 100%; padding: 12px 15px; margin-bottom: 15px; border: 2px solid var(--code-border);
            border-radius: var(--radius-md); background-color: var(--input-bg); color: var(--text-main);
            font-family: var(--font-family); font-size: 1em; outline: none; transition: all var(--transition-fast);
        }
        .modal-category-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102, 93, 245, 0.15); }
        .modal-category-list { max-height: 250px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 20px; }
        .modal-category-list div {
            padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border);
            transition: background-color var(--transition-fast), color var(--transition-fast);
            display: flex; align-items: center; gap: 8px; font-weight: 600;
        }
        .modal-category-list div:last-child { border-bottom: none; }
        .modal-category-list div:hover { background-color: rgba(128,128,128,0.1); color: var(--primary); }
        .modal-category-list div.selected { background-color: var(--primary); color: white; font-weight: 700; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .modal-btn {
            padding: 10px 20px; border-radius: var(--radius-md); font-weight: 700; transition: all var(--transition-fast);
        }
        .modal-btn.confirm { background-color: var(--primary); color: white; }
        .modal-btn.confirm:hover { background-color: var(--secondary); transform: translateY(-2px); box-shadow: var(--shadow-1); }
        .modal-btn.cancel { background-color: var(--ai-bg); color: var(--text-secondary); border: 1px solid var(--border); }
        .modal-btn.cancel:hover { background-color: var(--border); color: var(--text-main); transform: translateY(-2px); }

        /* --- Temporary Toast/Notification --- */
        #notification-toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background-color: var(--card-bg); color: var(--text-main); padding: 15px 25px;
            border-radius: var(--radius-lg); box-shadow: var(--shadow-2);
            opacity: 0; visibility: hidden; z-index: 3000;
            transition: opacity var(--transition-med), transform var(--transition-med);
            display: flex; align-items: center; gap: 10px; font-weight: 600;
            border: 1px solid var(--border);
        }
        #notification-toast.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(-10px); }


         /* === Responsive === */
         @media (max-width: 992px) { :root { --sidebar-width: 290px; } .message { max-width: 88%; } #conversation-display-messages { padding: 30px; gap: 22px; } }
         @media (max-width: 768px) {
             :root { --sidebar-width: 300px; }
             #sidebar { position: fixed; top: 0; right: 0; height: 100%; transform: translateX(100%); box-shadow: -5px 0 40px var(--shadow-color); z-index: 1010; border-left: none; }
            body.dark-mode #sidebar { box-shadow: -5px 0 45px rgba(0,0,0, 0.4); }
             #sidebar.visible { transform: translateX(0); }
            #sidebarToggle { display: block; }
            #main-content { width: 100%; border-radius: 0; }
             body::after { /* Mobile Overlay */ content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.55); -webkit-backdrop-filter: blur(5px); backdrop-filter: blur(5px); opacity: 0; visibility: hidden; transition: opacity var(--transition-med), visibility var(--transition-med), backdrop-filter var(--transition-med); z-index: 1005; }
             body.sidebar-overlay-active::after { opacity: 1; visibility: visible; }
            #conversation-display-messages { padding: 25px; gap: 22px; }
             .message { max-width: 92%; font-size: 1.05em; padding: 14px 20px; }
            #conversation-display-header { padding: 18px 25px; }
            #conversation-display-header h3 { font-size: 1.6em; }
            #currentCategory { font-size: 0.9em; padding: 6px 12px; }
        }
        /* =================================================================
           --- ðŸŽ¨ || CODEX DNA: THE UNIFIED THEME (FIRE & SHADOW) || ðŸŽ¨ ---
           ================================================================= */
        :root {
            /* === Dark Mode Palette (Default) === */
            --primary-dark: #FF3B3B;     /* Fiery Red Accent */
            --secondary-dark: #F0A500;   /* Molten Gold Accent */
            --bg-dark: #0a0a0b;           /* Deep Abyss Black */
            --sidebar-bg-dark: rgba(25, 25, 28, 0.6);
            --main-bg-dark: #121214;
            --card-bg-dark: #1A1A1C;
            --text-main-dark: #f0f0f5;
            --text-secondary-dark: #a0a0b0;
            --border-dark: #333333;
            --shadow-color-dark: rgba(255, 59, 59, 0.1);
            --user-bg-dark: linear-gradient(135deg, #8A2BE2, #6a1aab); /* User Purple from DragonMind */
            --user-text-dark: #ffffff;
            --ai-bg-dark: #28282C;
            --ai-text-dark: #dadadf;
            --code-bg-dark: #000000;
            --code-text-dark: #d0d0d0;
            --code-border-dark: #3a3f4d;
            --scrollbar-thumb-dark: #4d4d52;
            --backdrop-blur-dark: blur(25px) saturate(160%);
            
            /* === Light Mode Palette (Inspired by OmniView, Re-themed) === */
            --primary-light: #D32F2F;   /* Deeper Red */
            --secondary-light: #FFA000; /* Richer Gold */
            --bg-light: #f8f8fa;
            --sidebar-bg-light: rgba(255, 255, 255, 0.7);
            --main-bg-light: #ffffff;
            --card-bg-light: #ffffff;
            --text-main-light: #1A1A1A;
            --text-secondary-light: #5A5A5A;
            --border-light: #e0e0e0;
            --shadow-color-light: rgba(0, 0, 0, 0.08);
            --user-bg-light: linear-gradient(135deg, #7B1FA2, #5a0f82);
            --user-text-light: #ffffff;
            --ai-bg-light: #f0f1f5;
            --ai-text-light: #48484d;
            --code-bg-light: #F5F2F0; /* From Primer CSS */
            --code-text-light: #24292e;
            --code-border-light: #d1d5da;
            --scrollbar-thumb-light: #bfc0c5;
            --backdrop-blur-light: blur(22px) saturate(180%);
            
            /* --- Structure, Animation, Universal Styles --- */
            --font-main: 'Cairo', sans-serif;
            --font-code: 'Fira Code', monospace;
            --radius-lg: 18px; --radius-md: 12px; --radius-sm: 8px;
            --transition-med: 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: 0.2s ease-out;

            /* --- Assign Defaults (Dark Theme) --- */
            --primary: var(--primary-dark); --secondary: var(--secondary-dark); --bg: var(--bg-dark);
            --sidebar-bg: var(--sidebar-bg-dark); --main-bg: var(--main-bg-dark); --card-bg: var(--card-bg-dark);
            --text-main: var(--text-main-dark); --text-secondary: var(--text-secondary-dark); --border: var(--border-dark);
            --user-bg: var(--user-bg-dark); --user-text: var(--user-text-dark);
            --ai-bg: var(--ai-bg-dark); --ai-text: var(--ai-text-dark);
            --code-bg: var(--code-bg-dark); --code-text: var(--code-text-dark); --code-border: var(--code-border-dark);
            --scrollbar-thumb: var(--scrollbar-thumb-dark); --backdrop-blur: var(--backdrop-blur-dark);
            --shadow-color: var(--shadow-color-dark);
        }

        body.light-mode {
            --primary: var(--primary-light); --secondary: var(--secondary-light); --bg: var(--bg-light);
            --sidebar-bg: var(--sidebar-bg-light); --main-bg: var(--main-bg-light); --card-bg: var(--card-bg-light);
            --text-main: var(--text-main-light); --text-secondary: var(--text-secondary-light); --border: var(--border-light);
            --user-bg: var(--user-bg-light); --user-text: var(--user-text-light);
            --ai-bg: var(--ai-bg-light); --ai-text: var(--ai-text-light);
            --code-bg: var(--code-bg-light); --code-text: var(--code-text-light); --code-border: var(--code-border-light);
            --scrollbar-thumb: var(--scrollbar-thumb-light); --backdrop-blur: var(--backdrop-blur-light);
            --shadow-color: var(--shadow-color-light);
        }

        /* Base & Scrollbar (OmniView Style) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-main); background-color: var(--bg); color: var(--text-main); overflow: hidden; transition: background-color var(--transition-med), color var(--transition-med); }
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 10px; border: 3px solid transparent; background-clip: content-box; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* ========================================================
           --- ðŸ‰ || DRAGON'S LAIR: THE 3-COLUMN LAYOUT || ðŸ‰ ---
           ======================================================== */
        .omni-archive-app {
            display: grid; height: 100vh;
            grid-template-columns: 320px 1fr 320px;
            grid-template-rows: auto 1fr;
            grid-template-areas: "header header header" "sidebar-left main-workspace sidebar-right";
            transition: grid-template-columns var(--transition-med);
        }

        .app-header {
            grid-area: header; background-color: var(--card-bg); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: stretch; height: 55px; padding: 0 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.3); z-index: 100;
        }
        .header-controls { display: flex; align-items: center; gap: 15px; }
        .control-btn { background: none; border: none; color: var(--text-secondary); font-size: 1.2rem; cursor: pointer; transition: all var(--transition-fast); padding: 5px; border-radius: 5px; }
        .control-btn:hover { color: var(--primary); text-shadow: 0 0 8px var(--primary); transform: scale(1.1); }
        #darkModeToggle:hover { color: var(--secondary); text-shadow: 0 0 8px var(--secondary); }
        
        #breadcrumbs {
            flex-grow: 1; color: var(--text-secondary); font-size: 1em; display: flex; align-items: center;
            gap: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        #breadcrumbs .breadcrumb-main { color: var(--text-main); font-size: 1.1em; }
        #breadcrumbs .breadcrumb-main i { color: var(--primary); margin-left: 5px; }
        #breadcrumbs .breadcrumb-category { font-weight: normal; font-size: 0.9em; opacity: 0.8;}

        /* Sidebars (Glassmorphism Style) */
        .sidebar {
            padding: 20px 0; overflow-y: auto; background-color: var(--sidebar-bg);
            -webkit-backdrop-filter: var(--backdrop-blur); backdrop-filter: var(--backdrop-blur);
            border-left: 1px solid var(--border); border-right: 1px solid var(--border);
            transition: all var(--transition-med);
        }
        #sidebar-left { grid-area: sidebar-left; }
        #sidebar-right { grid-area: sidebar-right; }
        .sidebar-section { padding: 0 20px 20px; }
        .sidebar h3 { font-size: 1.2em; padding-bottom: 12px; margin-bottom: 15px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; color: var(--secondary); font-weight: 900; }

        /* Left Sidebar: Inputs, Search & File Tree */
        .input-container { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
        .file-input-label {
            display: flex; align-items: center; justify-content: center; gap: 10px; padding: 12px 18px; border-radius: var(--radius-md); font-weight: bold; cursor: pointer;
            transition: all var(--transition-fast); color: white; box-shadow: 0 2px 5px var(--shadow-color);
        }
        .file-input-label.json { background: linear-gradient(60deg, var(--primary), #b82d2d); }
        .file-input-label.folder { background: linear-gradient(60deg, var(--secondary), #b17a00); color: #111; }
        .file-input-label:hover { transform: translateY(-3px); box-shadow: 0 5px 15px var(--shadow-color); filter: brightness(1.15); }
        #fileInput, #folderInput { display: none; }
        
        #search-container { position: relative; margin-bottom: 15px; }
        #searchInput { width: 100%; background: var(--card-bg); color: var(--text-main); border: 2px solid var(--border); border-radius: var(--radius-md); padding: 12px 45px 12px 20px; font-family: var(--font-main); font-size: 1em; outline: none; transition: all var(--transition-med); }
        #searchInput:focus { border-color: var(--secondary); box-shadow: 0 0 0 4px rgba(240, 165, 0, 0.2); }
        #search-icon { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none; font-size: 1.2em; }
        
        /* Conversation List (OmniView Style) */
        #conversation-list-container { padding: 0 10px; }
        .category-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; margin: 8px 0 4px; cursor: pointer; border-radius: var(--radius-md); background: rgba(128,128,128,0.08); transition: var(--transition-fast); font-weight: bold; }
        .category-header:hover { background: var(--secondary); color: #111; }
        .category-title { display: flex; align-items: center; gap: 10px; }
        .category-count { font-size: 0.8em; opacity: 0.7; }
        .category-toggle-icon { transition: transform var(--transition-med); }
        .category-header.collapsed .category-toggle-icon { transform: rotate(-90deg); }

        .conversation-group { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 4px; overflow: hidden; transition: max-height 0.4s ease-out; }
        .conversation-group.collapsed { max-height: 0 !important; }
        .conversation-group li {
            padding: 10px 15px; margin: 0 5px; cursor: pointer; border-radius: var(--radius-sm); transition: all var(--transition-fast);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 700; position: relative; color: var(--text-secondary);
        }
        .conversation-group li::before { content: ''; position: absolute; top: 0; right: 0; height: 100%; width: 4px; background-color: var(--secondary); transform: scaleY(0); transition: transform 0.3s ease; transform-origin: bottom; border-radius: 0 4px 4px 0; }
        .conversation-group li:hover { background-color: rgba(128,128,128,0.08); color: var(--text-main); transform: translateX(-2px); }
        .conversation-group li:hover::before { transform: scaleY(1); transform-origin: top; }
        .conversation-group li.active { background: linear-gradient(95deg, var(--primary) 0%, #a52929 100%); color: white; font-weight: bold; border-color: transparent; }
        .conversation-group li.active:hover { filter: brightness(1.1); }
        .conversation-group li.hidden { display: none; }

        /* Right Sidebar: Conversation Analysis */
        .info-card { background-color: var(--card-bg); border-radius: var(--radius-md); padding: 15px; margin-bottom: 20px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); }
        .info-card p { display: flex; justify-content: space-between; font-size: 0.95em; color: var(--text-secondary); margin-bottom: 8px; }
        .info-card span { font-weight: bold; color: var(--text-main); }
        #top-words-list { list-style: none; display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        #top-words-list li { background-color: var(--ai-bg); color: var(--text-secondary); padding: 4px 10px; border-radius: var(--radius-sm); font-size: 0.85em; font-family: var(--font-code); }
        #downloadButton { width: 100%; font-weight: bold; color: white; padding: 12px; border-radius: var(--radius-md); background: #008f82; transition: var(--transition-fast); border:none; cursor:pointer;}
        #downloadButton:hover { filter: brightness(1.2); box-shadow: 0 3px 10px rgba(0,213,195,0.2); transform: translateY(-2px); }

        /* ========================================================
           --- ðŸ“œ || CODEX WORKSPACE: THE MAIN DISPLAY || ðŸ“œ ---
           ======================================================== */
        #main-workspace {
            grid-area: main-workspace; display: flex; flex-direction: column; overflow: hidden; background: var(--main-bg);
            border-right: 1px solid var(--border); border-left: 1px solid var(--border);
        }
        #chat-header {
            padding: 18px 35px; border-bottom: 1px solid var(--border); flex-shrink: 0; z-index: 50;
            display: flex; justify-content: space-between; align-items: center; background-color: var(--card-bg);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        #chat-header h2 { margin: 0; font-size: 1.8rem; font-weight: 900; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #editCategoryBtn {
            font-size: 1em; color: var(--text-secondary); font-weight: 600; background-color: var(--ai-bg); padding: 8px 15px;
            border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-fast);
            display: flex; align-items: center; gap: 8px; flex-shrink: 0; border: none; white-space: nowrap;
        }
        #editCategoryBtn:hover { background-color: var(--secondary); color: #111; transform: translateY(-2px); box-shadow: 0 3px 8px var(--shadow-color); }

        #message-container { flex-grow: 1; overflow-y: auto; padding: 35px 40px; display: flex; flex-direction: column; gap: 28px; }
        
        /* Message Bubbles & Animation (OmniView Polish) */
        .message { padding: 16px 24px; border-radius: var(--radius-lg); max-width: 85%; word-wrap: break-word; font-size: 1.05rem; opacity: 0; animation: messageReveal 0.6s var(--transition-med) forwards; box-shadow: 0 3px 6px rgba(0,0,0,0.2); transition: all var(--transition-fast); }
        @keyframes messageReveal { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .user-message { background: var(--user-bg); color: var(--user-text); align-self: flex-end; border-bottom-left-radius: var(--radius-sm); }
        .ai-message { background: var(--ai-bg); color: var(--ai-text); align-self: flex-start; border-bottom-right-radius: var(--radius-sm); }

        /* Initial Welcome View */
        #initial-view { text-align: center; color: var(--text-secondary); margin: auto; padding: 20px; }
        #initial-view i { font-size: 5rem; display: block; margin-bottom: 20px; color: var(--primary); animation: pulseDragon 3s infinite ease-in-out; }
        @keyframes pulseDragon { 0%, 100% { transform: scale(1); text-shadow: none; } 50% { transform: scale(1.1); text-shadow: 0 0 15px var(--primary); } }
        #initial-view h2 { font-size: 2.2em; font-weight: 900; margin-bottom: 10px; color: var(--text-main); }
        
        /* --- Superior Markdown Styling (from OmniView, Re-themed) --- */
        .message-content { margin-top: 5px; line-height: 1.8; }
        .message-content > *:first-child { margin-top: 0; } .message-content > *:last-child { margin-bottom: 0; }
        .message-content p { margin-bottom: 1em; }
        .message-content h1, .message-content h2, .message-content h3 { margin: 1.8em 0 1.1em; padding-bottom: 0.4em; border-bottom: 2px solid var(--border); font-weight: 900; }
        .message-content h1 { font-size: 1.9em; color: var(--primary); } .message-content h2 { font-size: 1.6em; } .message-content h3 { font-size: 1.4em; }
        .message-content ul, .message-content ol { margin-bottom: 1.1em; padding-right: 35px; }
        .message-content li { margin-bottom: 0.7em; } .message-content li::marker { color: var(--secondary); font-weight: bold; }
        .message-content blockquote { border-right: 6px solid var(--secondary); background-color: rgba(240, 165, 0, 0.05); padding: 16px 28px 16px 12px; margin: 1.6em 0; border-radius: 0 var(--radius-md) var(--radius-md) 0; border-left: none; }
        .message-content pre { position: relative; background-color: var(--code-bg); color: var(--code-text); border: 1px solid var(--code-border); border-radius: var(--radius-md); padding: 20px 22px; margin: 1.6em 0; overflow-x: auto; font-family: var(--font-code); direction: ltr; text-align: left; box-shadow: inset 0 2px 8px rgba(0,0,0,0.4); }
        .message-content code:not(pre code) { font-family: var(--font-code); font-size: 0.9em; background-color: var(--code-bg); padding: 0.35em 0.8em; border-radius: var(--radius-sm); border: 1px solid var(--code-border); color: var(--secondary); }
        .message-content pre code { background: none; padding: 0; border: none; font-size: inherit; }
        .code-copy-button { position: absolute; top: 12px; left: 12px; background: rgba(128,128,128,0.2); color: var(--text-secondary); border: 1px solid var(--code-border); padding: 5px 10px; border-radius: var(--radius-sm); cursor: pointer; opacity: 0; transition: var(--transition-fast); }
        .message-content pre:hover .code-copy-button { opacity: 1; }
        .code-copy-button.copied { background: #008f82; color: white; border-color: transparent;}
        .message-content table { border-collapse: separate; border-spacing: 0; margin: 2em 0; width: 100%; border: 1px solid var(--border); border-radius: var(--radius-md); overflow: hidden; }
        .message-content th, .message-content td { padding: 15px 20px; text-align: right; border-bottom: 1px solid var(--border); }
        .message-content td { border-right: 1px solid var(--border); } .message-content td:first-child { border-right: none; }
        .message-content th { background-color: var(--ai-bg); font-weight: 800; color: var(--text-secondary); font-size: 0.9em; }
        .message-content a { color: var(--primary); text-decoration: none; font-weight: 700; border-bottom: 2px dotted currentColor; transition: color var(--transition-fast), border-color 0.2s ease; padding-bottom: 2px; }
        .message-content a:hover { color: var(--secondary); border-bottom-style: solid; }

        /* Category Edit Modal (OmniView Style) */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: var(--transition-med); }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: var(--card-bg); border: 1px solid var(--border); padding: 30px; border-radius: var(--radius-lg); box-shadow: 0 10px 50px rgba(0,0,0,0.5); width: 90%; max-width: 500px; transform: scale(0.95) translateY(-20px); transition: transform var(--transition-med); }
        .modal-overlay.visible .modal-content { transform: scale(1) translateY(0); }
        .modal-content h3 { color: var(--secondary); margin-top: 0; margin-bottom: 20px; font-size: 1.6em; }
        .modal-category-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid var(--border); border-radius: var(--radius-md); background: var(--main-bg); color: var(--text-main); font-family: var(--font-main); outline: none; transition: var(--transition-fast); }
        .modal-category-input:focus { border-color: var(--secondary); }
        .modal-category-list { max-height: 250px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 20px; }
        .modal-category-list div { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border); transition: var(--transition-fast); font-weight: 600; }
        .modal-category-list div:last-child { border-bottom: none; }
        .modal-category-list div:hover { background: var(--ai-bg); }
        .modal-category-list div.selected { background: var(--secondary); color: #111; font-weight: bold; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .modal-btn { padding: 10px 20px; border-radius: var(--radius-md); font-weight: bold; border: none; cursor: pointer; transition: var(--transition-fast); }
        .modal-btn.confirm { background: var(--primary); color: white; }
        .modal-btn.confirm:hover { filter: brightness(1.2); }
        .modal-btn.cancel { background: var(--ai-bg); color: var(--text-secondary); }

        /* Notification Toast (OmniView Style) */
        #notification-toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background: var(--card-bg); color: var(--text-main); padding: 15px 25px; border-radius: var(--radius-lg); box-shadow: 0 5px 20px rgba(0,0,0,0.4); z-index: 2000; transition: all 0.5s ease-in-out; display: flex; align-items: center; gap: 10px; font-weight: 600; border: 1px solid var(--border); }
        #notification-toast.show { bottom: 30px; opacity: 1; transform: translateX(-50%) translateY(0); }
        #notification-toast span:first-child { font-size: 1.2em; }

        /* --- ðŸ“± || Responsive Design || ðŸ“± --- */
        @media (max-width: 1200px) { .omni-archive-app { grid-template-columns: 280px 1fr 280px; } }
        @media (max-width: 992px) {
            .omni-archive-app { grid-template-columns: 1fr; grid-template-rows: auto 1fr; grid-template-areas: "header" "main-workspace"; }
            .sidebar { position: fixed; top: 0; height: 100%; width: 320px; max-width: 90%; z-index: 100; transform: translateX(100%); transition: transform var(--transition-med); box-shadow: -10px 0 30px rgba(0,0,0,0.3); border-left: 1px solid var(--border); }
            #sidebar-left { right: 0; }
            #sidebar-right { right: 0; }
            .sidebar.visible { transform: translateX(0); }
            body.sidebar-open::after { content: ''; position: fixed; inset: 0; background: rgba(0,0,0,0.5); -webkit-backdrop-filter: blur(5px); backdrop-filter: blur(5px); z-index: 99; opacity: 1; transition: opacity var(--transition-med); }
            .message { max-width: 95%; }
            #chat-header h2 { font-size: 1.6em; }
            #breadcrumbs { display: none; }
        }
    </style>
</head>
<body class="dark-mode">

    <div class="omni-archive-app">
        <!-- ðŸ”ï¸ HEADER -->
        <header class="app-header">
            <div class="header-controls">
                <button class="control-btn" id="toggle-left-sidebar" title="ÙØªØ­ Ø§Ù„Ø£Ø±Ø´ÙŠÙ"><i class="fa-solid fa-folder-tree"></i></button>
            </div>
            <div id="breadcrumbs">
                 <!-- Populated by JS -->
            </div>
            <div class="header-controls">
                <button class="control-btn" id="toggle-right-sidebar" title="ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„"><i class="fa-solid fa-chart-simple"></i></button>
                <button class="control-btn" id="darkModeToggle" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­"><i class="fas fa-sun"></i></button>
            </div>
        </header>

        <!-- ðŸ—‚ï¸ SIDEBAR LEFT -->
        <aside class="sidebar" id="sidebar-left">
            <div class="sidebar-section">
                <h3><i class="fa-solid fa-upload"></i> Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª</h3>
                 <div class="input-container">
                     <label for="fileInput" class="file-input-label json">
                         <i class="fa-solid fa-file-code"></i>&nbsp; Ù…Ù„Ù (ChatGPT / DeepSeek)
                     </label>
                     <input type="file" id="fileInput" accept=".json">
                     
                     <label for="folderInput" class="file-input-label folder">
                         <i class="fa-solid fa-folder"></i>&nbsp; Ù…Ø¬Ù„Ø¯ (AI Studio)
                     </label>
                     <input type="file" id="folderInput" webkitdirectory directory multiple>
                 </div>
                 <div id="search-container">
                    <input type="search" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª...">
                    <i id="search-icon" class="fa-solid fa-magnifying-glass"></i>
                </div>
            </div>
            <div id="conversation-list-container">
                 <!-- Categories & conversations will be spawned here -->
            </div>
        </aside>

        <!-- ðŸ§© MAIN WORKSPACE -->
        <main id="main-workspace">
            <div id="chat-header">
                <h2 id="conversation-title-display">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø©</h2>
                <button id="editCategoryBtn" style="display: none;">
                    <span id="currentCategoryDisplay"></span>&nbsp;<i class="fa-solid fa-pen-to-square"></i>
                </button>
            </div>
            <div id="message-container">
                 <div id="initial-view">
                    <i class="fa-solid fa-dragon"></i>
                    <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ø®Ø·ÙˆØ·Ø© Ø§Ù„Ù†Ø§Ø±</h2>
                    <p>Ø£Ø·Ù„Ù‚ Ø§Ù„Ø¹Ù†Ø§Ù† Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø¨Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ù„ÙØ§ØªÙƒ Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠØ©.</p>
                </div>
            </div>
        </main>

        <!-- ðŸš€ SIDEBAR RIGHT -->
        <aside class="sidebar" id="sidebar-right">
            <div class="sidebar-section">
                <h3><i class="fa-solid fa-magnifying-glass-chart"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„</h3>
                <div class="info-card" id="conversation-meta">
                    <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: <span id="message-count">0</span></p>
                    <p>Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª: <span id="word-count">0</span></p>
                </div>
                
                <h3><i class="fa-solid fa-fire"></i> Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø´ØªØ¹Ø§Ù„Ø§Ù‹</h3>
                <div class="info-card">
                     <ul id="top-words-list"></ul>
                </div>

                <h3><i class="fa-solid fa-save"></i> Ø®ØªÙ… Ø§Ù„Ø°Ø§ÙƒØ±Ø©</h3>
                <button id="downloadButton"><i class="fa-solid fa-download"></i>&nbsp; Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            </div>
        </aside>
    </div>

    <!-- Modals and Toasts -->
    <div id="categoryEditModal" class="modal-overlay">
        <div class="modal-content">
            <h3>ØªØ¹Ø¯ÙŠÙ„ ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h3>
            <input type="text" id="modalCategoryInput" class="modal-category-input" placeholder="Ø§ÙƒØªØ¨ ØªØµÙ†ÙŠÙ Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ø§Ø®ØªØ±...">
            <div class="modal-category-list" id="modalCategoryList"></div>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="cancelCategoryEdit">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="modal-btn confirm" id="saveCategoryEdit">Ø­ÙØ¸</button>
            </div>
        </div>
    </div>

    <div id="notification-toast">
        <span class="toast-icon"></span> <span id="toast-message"></span>
    </div>

 <script>
    // =================================================================
    // --- ðŸ§  || THE ARCHIVIST'S MIND: UNIFIED JAVASCRIPT LOGIC || ðŸ§  ---
    // =================================================================
    document.addEventListener('DOMContentLoaded', () => {

        // --- DOM Cache: All components of the archive ---
        const dom = {
            body: document.body, fileInput: document.getElementById('fileInput'), folderInput: document.getElementById('folderInput'),
            conversationListContainer: document.getElementById('conversation-list-container'), messageContainer: document.getElementById('message-container'),
            conversationTitleDisplay: document.getElementById('conversation-title-display'), initialView: document.getElementById('initial-view'),
            breadcrumbs: document.getElementById('breadcrumbs'), wordCountDisplay: document.getElementById('word-count'), messageCountDisplay: document.getElementById('message-count'),
            topWordsList: document.getElementById('top-words-list'), darkModeToggle: document.getElementById('darkModeToggle'),
            toggleLeftSidebar: document.getElementById('toggle-left-sidebar'), toggleRightSidebar: document.getElementById('toggle-right-sidebar'),
            sidebarLeft: document.getElementById('sidebar-left'), sidebarRight: document.getElementById('sidebar-right'),
            searchInput: document.getElementById('searchInput'), downloadButton: document.getElementById('downloadButton'),
            editCategoryBtn: document.getElementById('editCategoryBtn'), currentCategoryDisplay: document.getElementById('currentCategoryDisplay'),
            categoryEditModal: document.getElementById('categoryEditModal'), modalCategoryInput: document.getElementById('modalCategoryInput'),
            modalCategoryList: document.getElementById('modalCategoryList'), cancelCategoryEditBtn: document.getElementById('cancelCategoryEdit'),
            saveCategoryEditBtn: document.getElementById('saveCategoryEdit'), notificationToast: document.getElementById('notification-toast'),
            toastMessage: document.getElementById('toast-message'), toastIcon: document.querySelector('#notification-toast .toast-icon')
        };

        // --- State Management ---
        let allConversations = [];
        let activeConversationIndex = -1;
        let activeListItem = null;

        // --- Constants & Config ---
        const STOP_WORDS = new Set(['ÙÙŠ','Ù…Ù†','Ø¹Ù„Ù‰','Ùˆ','ÙŠØ§','Ù‡Ùˆ','Ù‡ÙŠ','Ø£Ù†Ø§','Ø§Ù†Øª','Ø¥Ù„Ù‰','Ø¹Ù†','ØªÙ…','Ù‚Ø¯','Ø£Ù†','Ù‡Ø°Ø§','Ù‡Ø°Ù‡','Ø°Ù„Ùƒ','Ù…Ø¹','ÙƒÙ„','ÙŠÙƒÙˆÙ†','ÙƒØ§Ù†','Ù„Ø§','Ù…Ø§','Ù„Ùˆ','Ø¨Ø³','ÙŠØ¹Ù†ÙŠ','Ø£Ùˆ','Ø§Ù„Ù„ÙŠ','Ø¯Ù‡','Ø¯ÙŠ','ÙÙŠÙ‡','Ø¬Ø¯Ø§','Ø·ÙŠØ¨','ØªÙ…Ø§Ù…','Ø¥ÙŠÙ‡','Ø²ÙŠ','Ù…Ø´','Ø§Ù‡','the','a','an','is','are','was','were','in','on','at','of','to','for','with','by','and','or','but','if','you','i','me','my','he','she','it','we','they','that','this','what','which','who','when','where','why','how','can','will','do','does','did','not','so','be','just','very','also','Ù„ÙƒÙ†','Ù‡Ù„','ÙƒÙŠÙ','Ù…ØªÙ‰','Ø£ÙŠÙ†','Ù„Ù…Ø§Ø°Ø§','Ø¹Ù†Ø¯ÙŠ','Ø¹Ù†Ø¯Ùƒ','Ù„Ø¯Ù‰']);
        const USER_IDENTIFIERS = ['user', 'Ø£Ù†Ø§', 'Ø£Ù†Øª'];
        const categoryIcons = {"PROJECT_DRAGON":"ðŸ‰","AI_and_ML":"ðŸ§ ","Programming":"ðŸ’»","Cybersecurity":"ðŸ”’","Business_and_Startups":"ðŸ’¼","Hardware_and_OS":"ðŸ–¥ï¸","Design_and_Content":"ðŸŽ¨","Personal_Development":"âœ¨","Philosophy_and_Life":"ðŸ’¡","Religion_and_Spirituality":"ðŸ•Œ","Personal_and_Supportive":"â¤ï¸","Miscellaneous":"â“","Empty_Chat":"ðŸ‘»","Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ":"ðŸ“","Uncategorized":"ðŸ“",};
        
        // --- Initialization ---
        initializeTheme();
        bindEventListeners();
        resetUIOnLaunch();
        
        // ============================
        // --- Event Listener Binding ---
        // ============================
        function bindEventListeners() {
            dom.fileInput.addEventListener('change', handleFileSelect);
            dom.folderInput.addEventListener('change', handleFolderSelect);
            dom.darkModeToggle.addEventListener('click', toggleDarkMode);
            dom.toggleLeftSidebar.addEventListener('click', () => toggleSidebar(dom.sidebarLeft));
            dom.toggleRightSidebar.addEventListener('click', () => toggleSidebar(dom.sidebarRight));
            dom.searchInput.addEventListener('input', filterAndRenderConversationList);
            dom.downloadButton.addEventListener('click', downloadConversations);
            dom.editCategoryBtn.addEventListener('click', openCategoryEditModal);
            dom.cancelCategoryEditBtn.addEventListener('click', closeCategoryEditModal);
            dom.saveCategoryEditBtn.addEventListener('click', saveCategoryChange);
            dom.modalCategoryInput.addEventListener('input', () => populateModalCategoryList(dom.modalCategoryInput.value));
            
            dom.categoryEditModal.addEventListener('click', (e) => { if (e.target === dom.categoryEditModal) closeCategoryEditModal(); });
            document.addEventListener('click', (event) => {
                if (!dom.body.classList.contains('sidebar-open')) return;
                const visibleSidebar = document.querySelector('.sidebar.visible');
                if (visibleSidebar && !visibleSidebar.contains(event.target) && !event.target.closest('button[id^="toggle-"]')) {
                    toggleSidebar(visibleSidebar, false);
                }
            });
        }
        
        // ========================================================
        // SECTION: Universal Data Transformation Engine (from DragonMind)
        // ========================================================
        function transformChatGPTData(rawData) {
            return rawData.map(convoData => {
                const messages = []; const mapping = convoData.mapping; if (!mapping) return { title: convoData.title || "Ù…Ø­Ø§Ø¯Ø«Ø© ØºØ§Ù…Ø¶Ø©", messages: [], category: "Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ" };
                let rootNode = Object.values(mapping).find(node => node.parent === null); if (!rootNode) return { title: convoData.title, messages: [], category: "Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ" };
                let currentNodeId = rootNode.children.length > 0 ? rootNode.children[0] : null;
                while (currentNodeId) {
                    const node = mapping[currentNodeId]; if (!node || !node.message) break;
                    const role = node.message.author?.role; const contentParts = node.message.content?.parts;
                    if ((role === 'user' || role === 'assistant') && contentParts && contentParts.join('').trim() !== '') {
                        messages.push({ author: role === 'user' ? 'user' : 'ChatGPT', content: contentParts.join('\n') });
                    }
                    currentNodeId = node.children.length > 0 ? node.children[0] : null;
                }
                return { title: convoData.title, messages: messages, category: "Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ" };
            });
        }

        function transformDeepSeekData(rawData) {
             return rawData.map((convo, index) => {
                 const newConvo = { title: convo.title || `Ø¥Ø´Ø§Ø±Ø© DeepSeek #${index + 1}`, messages: [], category: "Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ" };
                 const mapping = convo.mapping; if (!mapping || !mapping.root || !mapping.root.children) return newConvo;
                 let currentNodeId = mapping.root.children[0]; let isUserTurn = true; 
                 while (currentNodeId) {
                     const messageNode = mapping[currentNodeId];
                     if (messageNode && messageNode.message && typeof messageNode.message.content === 'string') {
                         newConvo.messages.push({ author: isUserTurn ? 'user' : 'DeepSeek', content: messageNode.message.content });
                         isUserTurn = !isUserTurn;
                     }
                     currentNodeId = messageNode && messageNode.children.length > 0 ? messageNode.children[0] : null;
                 }
                 return newConvo;
             });
        }

        function transformAiStudioData(fileName, content) {
            const data = JSON.parse(content); if (!data.chunkedPrompt || !Array.isArray(data.chunkedPrompt.chunks)) return null;
            const messages = data.chunkedPrompt.chunks.filter(chunk => chunk.role && chunk.text && !chunk.isThought).map(chunk => ({ author: chunk.role === 'user' ? 'user' : 'AI Studio', content: chunk.text }));
            return { title: fileName.replace('.json', ''), messages: messages, category: "Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ" };
        }

        function detectAndProcessFileContent(content) {
            try {
                const data = JSON.parse(content); let transformedData;
                if (Array.isArray(data)) {
                    if (data.length === 0) throw new Error("Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ØµÙÙˆÙØ© ÙØ§Ø±ØºØ©.");
                    if (data[0].mapping && data[0].mapping.root) { showToast("ðŸ§¬ ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø¥Ø´Ø§Ø±Ø© DeepSeek..."); transformedData = transformDeepSeekData(data); }
                    else if (data[0].mapping) { showToast("ðŸ¤– ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø¥Ø´Ø§Ø±Ø© ChatGPT..."); transformedData = transformChatGPTData(data); }
                    else if (data[0].messages) { showToast("ðŸ“œ ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø±Ø´ÙŠÙ..."); transformedData = data; }
                    else { throw new Error("Ø¨Ù†ÙŠØ© Ù…ØµÙÙˆÙØ© JSON ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©."); }
                } else if (typeof data === 'object' && data !== null) {
                    showToast("âœ¨ ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø¥Ø´Ø§Ø±Ø© AI Studio...");
                    const singleConvo = transformAiStudioData("Imported File", content);
                    if (singleConvo) { transformedData = [singleConvo]; } else { throw new Error("Ø¨Ù†ÙŠØ© ÙƒØ§Ø¦Ù† JSON ØºÙŠØ± Ù…ØªÙˆØ§ÙÙ‚Ø©."); }
                } else { throw new Error("Ø§Ù„Ù…Ù„Ù Ù„ÙŠØ³ Ø¨ØµÙŠØºØ© JSON ØµØ§Ù„Ø­Ø©."); }
                processAllConversations(transformedData);
            } catch (e) { handleFileReadError(e); }
        }

        // ===================================
        // --- Core Application Logic ---
        // ===================================
        function handleFileSelect(event) {
            const file = event.target.files[0]; if (!file) return; resetUIForLoad();
            const reader = new FileReader();
            reader.onload = (e) => detectAndProcessFileContent(e.target.result);
            reader.onerror = (err) => handleFileReadError(err);
            reader.readAsText(file);
        }

        async function handleFolderSelect(event) {
            const files = event.target.files; if (!files || files.length === 0) return; resetUIForLoad();
            showToast(`âœ¨ Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ${files.length} Ø°Ø§ÙƒØ±Ø© Ù…Ù† AI Studio...`);
            const promises = Array.from(files).map(file => file.name.endsWith('.json') ? file.text().then(content => ({ name: file.name, content })) : Promise.resolve(null));
            try {
                const fileContents = (await Promise.all(promises)).filter(Boolean);
                const transformedData = fileContents.map(file => { try { return transformAiStudioData(file.name, file.content); } catch (e) { return null; }}).filter(Boolean);
                processAllConversations(transformedData);
            } catch(e) { handleFileReadError(e); }
        }

        function processAllConversations(data) {
            allConversations = data.map(convo => ({ category: "Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ", ...convo }));
            requestAnimationFrame(() => {
                if (allConversations.length > 0) {
                    filterAndRenderConversationList(); // This renders the full list initially
                    dom.initialView.style.display = 'none';
                    const firstItem = dom.conversationListContainer.querySelector('li');
                    if (firstItem) firstItem.click();
                    showToast(`âœ… ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ${allConversations.length} Ø°Ø§ÙƒØ±Ø© Ø¨Ù†Ø¬Ø§Ø­.`, true);
                } else { handleFileReadError(new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø­Ø§Ø¯Ø«Ø§Øª ØµØ§Ù„Ø­Ø©.")); }
            });
        }
        
        // This function filters the master list AND renders the result
        function filterAndRenderConversationList() {
            dom.conversationListContainer.innerHTML = '';
            if (allConversations.length === 0) return;
            const searchTerm = dom.searchInput.value.toLowerCase();
            const filteredConversations = allConversations.map((convo, index) => ({...convo, originalIndex: index}))
                                                       .filter(convo => (convo.title || "").toLowerCase().includes(searchTerm));

            const grouped = filteredConversations.reduce((acc, convo) => {
                const category = convo.category || 'Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ';
                if (!acc[category]) acc[category] = [];
                acc[category].push(convo);
                return acc;
            }, {});
            
            const sortedCategories = Object.keys(grouped).sort((a,b) => {
                if (a === 'Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ') return 1; if (b === 'Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ') return -1;
                return a.localeCompare(b);
            });
            const fragment = document.createDocumentFragment();

            sortedCategories.forEach(category => {
                const convos = grouped[category];
                const header = document.createElement('div');
                header.className = 'category-header';
                const icon = categoryIcons[category.replace(/\s/g, '_')] || 'ðŸ“';
                header.innerHTML = `<div class="category-title"><span>${icon}</span><span>${category}</span></div><div class="category-info"><span class="category-count">(${convos.length})</span><span class="category-toggle-icon"><i class="fas fa-chevron-down"></i></span></div>`;
                
                const ul = document.createElement('ul');
                ul.className = 'conversation-group';
                convos.forEach(({ title, originalIndex }) => {
                    const li = document.createElement('li');
                    li.textContent = title || `Ù…Ø­Ø§Ø¯Ø«Ø© ØºØ§Ù…Ø¶Ø© #${originalIndex + 1}`; li.dataset.index = originalIndex;
                    li.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (activeListItem) activeListItem.classList.remove('active');
                        li.classList.add('active'); activeListItem = li;
                        displayConversation(originalIndex);
                        if (window.innerWidth <= 992) toggleSidebar(dom.sidebarLeft, false);
                    });
                    ul.appendChild(li);
                });
                header.addEventListener('click', () => {
                    const listToToggle = header.nextElementSibling;
                    header.classList.toggle('collapsed'); listToToggle.classList.toggle('collapsed');
                    listToToggle.style.maxHeight = listToToggle.classList.contains('collapsed') ? '0px' : `${listToToggle.scrollHeight}px`;
                });
                fragment.appendChild(header);
                fragment.appendChild(ul);
            });
            dom.conversationListContainer.appendChild(fragment);

            // Set initial heights for expansion
            dom.conversationListContainer.querySelectorAll('.conversation-group:not(.collapsed)').forEach(group => { group.style.maxHeight = `${group.scrollHeight}px`; });
            
            // Re-select active conversation if it's visible after filtering
             if(activeConversationIndex !== -1) {
                const currentLi = dom.conversationListContainer.querySelector(`li[data-index="${activeConversationIndex}"]`);
                if(currentLi) { currentLi.classList.add('active'); activeListItem = currentLi; }
            }
        }
        
        function displayConversation(index) {
            if (index < 0 || index >= allConversations.length) return;
            activeConversationIndex = index;
            const conversation = allConversations[index];
            
            dom.initialView.style.display = 'none';
            dom.editCategoryBtn.style.display = 'flex';
            dom.conversationTitleDisplay.textContent = conversation.title;
            dom.currentCategoryDisplay.textContent = conversation.category || 'Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ';
            dom.breadcrumbs.innerHTML = `<span class="breadcrumb-main"><i class="fa-solid fa-dragon"></i> Ù…Ø®Ø·ÙˆØ·Ø© Ø§Ù„Ù†Ø§Ø±</span> <i class="fa-solid fa-angle-right"></i> <span class="breadcrumb-category">${conversation.category}</span>`;
            
            dom.messageContainer.innerHTML = '';
            const fragment = document.createDocumentFragment();
            if (conversation.messages && conversation.messages.length > 0) {
                conversation.messages.forEach(msg => { if(msg && msg.content) fragment.appendChild(createMessageElement(msg)); });
            } else {
                const p = document.createElement('p'); p.textContent = 'Ù‡Ø°Ù‡ Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙØ§Ø±ØºØ©... Ø³ÙƒÙˆÙ† ØªØ§Ù….'; p.style.textAlign = 'center'; fragment.appendChild(p);
            }
            dom.messageContainer.appendChild(fragment);
            dom.messageContainer.scrollTop = 0;
            addCodeCopyButtons();
            analyzeAndDisplayMetadata(conversation);
        }
        
        function createMessageElement(msg) {
            const isUser = USER_IDENTIFIERS.includes(msg.author?.toLowerCase());
            const wrapper = document.createElement('div');
            wrapper.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
            
            const content = document.createElement('div');
            content.className = 'message-content';
            content.innerHTML = DOMPurify.sanitize(marked.parse(msg.content));
            
            wrapper.appendChild(content);
            return wrapper;
        }

        function analyzeAndDisplayMetadata(conversation) {
            const messages = conversation.messages || []; const fullText = messages.map(m => m.content).join(' '); const words = fullText.split(/\s+/).filter(Boolean);
            dom.messageCountDisplay.textContent = messages.length; dom.wordCountDisplay.textContent = words.length;
            const freqs = new Map();
            words.map(w => w.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"")).forEach(w => { if (w && !STOP_WORDS.has(w)) freqs.set(w, (freqs.get(w) || 0) + 1); });
            const topWords = Array.from(freqs.entries()).sort((a, b) => b[1] - a[1]).slice(0, 10);
            dom.topWordsList.innerHTML = '';
            topWords.forEach(([word, count]) => {
                const li = document.createElement('li'); li.textContent = `${word} (${count})`; dom.topWordsList.appendChild(li);
            });
        }
        
        function addCodeCopyButtons() {
            dom.messageContainer.querySelectorAll('pre').forEach(pre => {
                if (pre.querySelector('.code-copy-button')) return;
                const btn = document.createElement('button'); btn.className = 'code-copy-button'; btn.innerHTML = '<i class="fa-solid fa-copy"></i>';
                btn.addEventListener('click', () => {
                    navigator.clipboard.writeText(pre.querySelector('code').innerText).then(() => {
                        btn.classList.add('copied'); btn.innerHTML = '<i class="fa-solid fa-check"></i>';
                        setTimeout(() => { btn.classList.remove('copied'); btn.innerHTML = '<i class="fa-solid fa-copy"></i>'; }, 2000);
                    });
                });
                pre.appendChild(btn);
            });
        }
        
        // ============================
        // --- Components & UI Helpers ---
        // ============================
        let selectedCategoryForEdit = '';
        function openCategoryEditModal() {
            if (activeConversationIndex === -1) { showToast('âš ï¸ Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø© Ø£ÙˆÙ„Ø§Ù‹!', false); return; }
            const currentCategory = allConversations[activeConversationIndex].category || 'Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ';
            dom.modalCategoryInput.value = currentCategory;
            selectedCategoryForEdit = currentCategory;
            populateModalCategoryList();
            dom.categoryEditModal.classList.add('visible');
        }

        function populateModalCategoryList(filter = '') {
            dom.modalCategoryList.innerHTML = '';
            const unique = [...new Set(allConversations.map(c => c.category || 'Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ'))].sort();
            unique.filter(c => c.toLowerCase().includes(filter.toLowerCase())).forEach(cat => {
                const div = document.createElement('div');
                div.textContent = cat;
                if (cat === selectedCategoryForEdit) div.classList.add('selected');
                div.addEventListener('click', () => {
                    dom.modalCategoryInput.value = cat;
                    dom.modalCategoryList.querySelectorAll('div').forEach(i => i.classList.remove('selected'));
                    div.classList.add('selected'); selectedCategoryForEdit = cat;
                });
                dom.modalCategoryList.appendChild(div);
            });
        }
        
        function saveCategoryChange() {
            if (activeConversationIndex === -1) return;
            const newCategory = dom.modalCategoryInput.value.trim();
            if (!newCategory) { showToast('âš ï¸ Ø§Ù„ØªØµÙ†ÙŠÙ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºÙ‹Ø§!', false); return; }
            allConversations[activeConversationIndex].category = newCategory;
            
            // Re-render the sidebar to reflect potential changes
            filterAndRenderConversationList();
            
            // Update the current view
            dom.currentCategoryDisplay.textContent = newCategory;
            dom.breadcrumbs.querySelector('.breadcrumb-category').textContent = newCategory;
            
            closeCategoryEditModal();
            showToast(`âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØµÙ†ÙŠÙ Ø¥Ù„Ù‰ "${newCategory}"`);
        }
        function closeCategoryEditModal() { dom.categoryEditModal.classList.remove('visible'); }
        
        function downloadConversations() {
            if (allConversations.length === 0) { showToast('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø°ÙƒØ±ÙŠØ§Øª Ù„Ø­ÙØ¸Ù‡Ø§.', false); return; }
            const json = JSON.stringify(allConversations, null, 2); const blob = new Blob([json], { type: 'application/json' }); const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'Codex_Ignis_Export.json';
            a.click(); URL.revokeObjectURL(url);
            showToast('ðŸ“¥ ØªÙ… Ø®ØªÙ… Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
        }

        function resetUIForLoad() {
            dom.messageContainer.innerHTML = '<div></div>'; // Skeleton can be added here
            dom.conversationTitleDisplay.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡...';
            dom.editCategoryBtn.style.display = 'none';
            activeConversationIndex = -1; activeListItem = null;
            resetAnalysisPane();
        }
        
        function resetUIOnLaunch() {
            resetUIForLoad();
            dom.conversationTitleDisplay.textContent = 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø©';
            dom.breadcrumbs.innerHTML = `<span class="breadcrumb-main"><i class="fa-solid fa-dragon"></i> Ù…Ø®Ø·ÙˆØ·Ø© Ø§Ù„Ù†Ø§Ø±</span>`;
            dom.messageContainer.innerHTML = ''; // Clear skeleton
            dom.initialView.style.display = 'flex'; // show initial
            dom.initialView.style.flexDirection = 'column';
            dom.initialView.style.justifyContent = 'center';
        }
        
        function resetAnalysisPane() {
            dom.messageCountDisplay.textContent = '0'; dom.wordCountDisplay.textContent = '0'; dom.topWordsList.innerHTML = '';
        }

        function toggleSidebar(sidebar, forceState) {
            const shouldBeVisible = forceState === undefined ? !sidebar.classList.contains('visible') : forceState;
            // Ensure only one sidebar is open at a time on small screens
            if (shouldBeVisible && window.innerWidth <= 992) {
                if (sidebar === dom.sidebarLeft && dom.sidebarRight.classList.contains('visible')) toggleSidebar(dom.sidebarRight, false);
                if (sidebar === dom.sidebarRight && dom.sidebarLeft.classList.contains('visible')) toggleSidebar(dom.sidebarLeft, false);
            }
            sidebar.classList.toggle('visible', shouldBeVisible);
            const anySidebarVisible = dom.sidebarLeft.classList.contains('visible') || dom.sidebarRight.classList.contains('visible');
            dom.body.classList.toggle('sidebar-open', anySidebarVisible);
        }
        
        function initializeTheme() { if (localStorage.getItem('theme') === 'light') toggleDarkMode(true); }

        function toggleDarkMode(forceLight = false) {
            const currentlyDark = dom.body.classList.contains('dark-mode');
            const turnLight = forceLight ? true : currentlyDark;

            dom.body.classList.toggle('dark-mode', !turnLight);
            dom.body.classList.toggle('light-mode', turnLight);
            dom.darkModeToggle.innerHTML = turnLight ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
            dom.darkModeToggle.title = turnLight ? 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¸Ù„Ù…' : 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­';
            if(!forceLight) localStorage.setItem('theme', turnLight ? 'light' : 'dark');
        }

        let toastTimeout;
        function showToast(message, isSuccess = true) {
            clearTimeout(toastTimeout);
            dom.toastMessage.textContent = message;
            dom.toastIcon.innerHTML = isSuccess ? 'âœ…' : 'âš ï¸';
            dom.notificationToast.style.borderLeft = `4px solid ${isSuccess ? '#00c5a7' : 'var(--primary)'}`;
            dom.notificationToast.classList.add('show');
            toastTimeout = setTimeout(() => dom.notificationToast.classList.remove('show'), 3500);
        }

        function handleFileReadError(e) {
             showToast(`Ø®Ø·Ø£ ÙØ§Ø¯Ø­: ${e.message}`, false);
             resetUIOnLaunch();
        }
    });
</script>

</body>
</html>
