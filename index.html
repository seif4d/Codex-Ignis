<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codex Ignis ğŸ“œ The Omni-Archive</title>

    <!-- Libs: Marked, DOMPurify & FontAwesome -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.4.0/dist/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&family=Fira+Code&display=swap" rel="stylesheet">

    <style>

        /* =================================================================
           --- ğŸ¨ || CODEX DNA: THE UNIFIED THEME (FIRE & SHADOW) || ğŸ¨ ---
           ================================================================= */
        :root {
            /* === Dark Mode Palette (Default) === */
            --primary-dark: #FF3B3B;     /* Fiery Red Accent */
            --secondary-dark: #F0A500;   /* Molten Gold Accent */
            --bg-dark: #0a0a0b;           /* Deep Abyss Black */
            --sidebar-bg-dark: rgba(25, 25, 28, 0.6);
            --main-bg-dark: #121214;
            --card-bg-dark: #1A1A1C;
            --text-main-dark: #f0f0f5;
            --text-secondary-dark: #a0a0b0;
            --border-dark: #333333;
            --shadow-color-dark: rgba(255, 59, 59, 0.1);
            --user-bg-dark: linear-gradient(135deg, #8A2BE2, #6a1aab); /* User Purple from DragonMind */
            --user-text-dark: #ffffff;
            --ai-bg-dark: #28282C;
            --ai-text-dark: #dadadf;
            --code-bg-dark: #000000;
            --code-text-dark: #d0d0d0;
            --code-border-dark: #3a3f4d;
            --scrollbar-thumb-dark: #4d4d52;
            --backdrop-blur-dark: blur(25px) saturate(160%);
            
            /* === Light Mode Palette (Inspired by OmniView, Re-themed) === */
            --primary-light: #D32F2F;   /* Deeper Red */
            --secondary-light: #FFA000; /* Richer Gold */
            --bg-light: #f8f8fa;
            --sidebar-bg-light: rgba(255, 255, 255, 0.7);
            --main-bg-light: #ffffff;
            --card-bg-light: #ffffff;
            --text-main-light: #1A1A1A;
            --text-secondary-light: #5A5A5A;
            --border-light: #e0e0e0;
            --shadow-color-light: rgba(0, 0, 0, 0.08);
            --user-bg-light: linear-gradient(135deg, #7B1FA2, #5a0f82);
            --user-text-light: #ffffff;
            --ai-bg-light: #f0f1f5;
            --ai-text-light: #48484d;
            --code-bg-light: #F5F2F0; /* From Primer CSS */
            --code-text-light: #24292e;
            --code-border-light: #d1d5da;
            --scrollbar-thumb-light: #bfc0c5;
            --backdrop-blur-light: blur(22px) saturate(180%);
            
            /* --- Structure, Animation, Universal Styles --- */
            --font-main: 'Cairo', sans-serif;
            --font-code: 'Fira Code', monospace;
            --radius-lg: 18px; --radius-md: 12px; --radius-sm: 8px;
            --transition-med: 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: 0.2s ease-out;

            /* --- Assign Defaults (Dark Theme) --- */
            --primary: var(--primary-dark); --secondary: var(--secondary-dark); --bg: var(--bg-dark);
            --sidebar-bg: var(--sidebar-bg-dark); --main-bg: var(--main-bg-dark); --card-bg: var(--card-bg-dark);
            --text-main: var(--text-main-dark); --text-secondary: var(--text-secondary-dark); --border: var(--border-dark);
            --user-bg: var(--user-bg-dark); --user-text: var(--user-text-dark);
            --ai-bg: var(--ai-bg-dark); --ai-text: var(--ai-text-dark);
            --code-bg: var(--code-bg-dark); --code-text: var(--code-text-dark); --code-border: var(--code-border-dark);
            --scrollbar-thumb: var(--scrollbar-thumb-dark); --backdrop-blur: var(--backdrop-blur-dark);
            --shadow-color: var(--shadow-color-dark);
        }

        body.light-mode {
            --primary: var(--primary-light); --secondary: var(--secondary-light); --bg: var(--bg-light);
            --sidebar-bg: var(--sidebar-bg-light); --main-bg: var(--main-bg-light); --card-bg: var(--card-bg-light);
            --text-main: var(--text-main-light); --text-secondary: var(--text-secondary-light); --border: var(--border-light);
            --user-bg: var(--user-bg-light); --user-text: var(--user-text-light);
            --ai-bg: var(--ai-bg-light); --ai-text: var(--ai-text-light);
            --code-bg: var(--code-bg-light); --code-text: var(--code-text-light); --code-border: var(--code-border-light);
            --scrollbar-thumb: var(--scrollbar-thumb-light); --backdrop-blur: var(--backdrop-blur-light);
            --shadow-color: var(--shadow-color-light);
        }

        /* Base & Scrollbar (OmniView Style) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-main); background-color: var(--bg); color: var(--text-main); overflow: hidden; transition: background-color var(--transition-med), color var(--transition-med); }
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 10px; border: 3px solid transparent; background-clip: content-box; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* ========================================================
           --- ğŸ‰ || DRAGON'S LAIR: THE 3-COLUMN LAYOUT || ğŸ‰ ---
           ======================================================== */
        .omni-archive-app {
            display: grid; height: 100vh;
            grid-template-columns: 320px 1fr 320px;
            grid-template-rows: auto 1fr;
            grid-template-areas: "header header header" "sidebar-left main-workspace sidebar-right";
            transition: grid-template-columns var(--transition-med);
        }

        .app-header {
            grid-area: header; background-color: var(--card-bg); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: stretch; height: 55px; padding: 0 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.3); z-index: 100;
        }
        .header-controls { display: flex; align-items: center; gap: 15px; }
        .control-btn { background: none; border: none; color: var(--text-secondary); font-size: 1.2rem; cursor: pointer; transition: all var(--transition-fast); padding: 5px; border-radius: 5px; }
        .control-btn:hover { color: var(--primary); text-shadow: 0 0 8px var(--primary); transform: scale(1.1); }
        #darkModeToggle:hover { color: var(--secondary); text-shadow: 0 0 8px var(--secondary); }
        
        #breadcrumbs {
            flex-grow: 1; color: var(--text-secondary); font-size: 1em; display: flex; align-items: center;
            gap: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        #breadcrumbs .breadcrumb-main { color: var(--text-main); font-size: 1.1em; }
        #breadcrumbs .breadcrumb-main i { color: var(--primary); margin-left: 5px; }
        #breadcrumbs .breadcrumb-category { font-weight: normal; font-size: 0.9em; opacity: 0.8;}

        /* Sidebars (Glassmorphism Style) */
        .sidebar {
            padding: 20px 0; overflow-y: auto; background-color: var(--sidebar-bg);
            -webkit-backdrop-filter: var(--backdrop-blur); backdrop-filter: var(--backdrop-blur);
            border-left: 1px solid var(--border); border-right: 1px solid var(--border);
            transition: all var(--transition-med);
        }
        #sidebar-left { grid-area: sidebar-left; }
        #sidebar-right { grid-area: sidebar-right; }
        .sidebar-section { padding: 0 20px 20px; }
        .sidebar h3 { font-size: 1.2em; padding-bottom: 12px; margin-bottom: 15px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; color: var(--secondary); font-weight: 900; }

        /* Left Sidebar: Inputs, Search & File Tree */
        .input-container { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
        .file-input-label {
            display: flex; align-items: center; justify-content: center; gap: 10px; padding: 12px 18px; border-radius: var(--radius-md); font-weight: bold; cursor: pointer;
            transition: all var(--transition-fast); color: white; box-shadow: 0 2px 5px var(--shadow-color);
        }
        .file-input-label.json { background: linear-gradient(60deg, var(--primary), #b82d2d); }
        .file-input-label.folder { background: linear-gradient(60deg, var(--secondary), #b17a00); color: #111; }
        .file-input-label:hover { transform: translateY(-3px); box-shadow: 0 5px 15px var(--shadow-color); filter: brightness(1.15); }
        #fileInput, #folderInput { display: none; }
        
        #search-container { position: relative; margin-bottom: 15px; }
        #searchInput { width: 100%; background: var(--card-bg); color: var(--text-main); border: 2px solid var(--border); border-radius: var(--radius-md); padding: 12px 45px 12px 20px; font-family: var(--font-main); font-size: 1em; outline: none; transition: all var(--transition-med); }
        #searchInput:focus { border-color: var(--secondary); box-shadow: 0 0 0 4px rgba(240, 165, 0, 0.2); }
        #search-icon { position: absolute; top: 50%; right: 15px; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none; font-size: 1.2em; }
        
        .search-options {
            display: flex; align-items: center; gap: 12px;
            margin: -5px 0 15px 0; /* Position below search bar */
        }
        .search-options .toggle-label-text {
            font-weight: 600; font-size: 0.9em; color: var(--text-secondary); cursor: pointer;
            user-select: none; transition: color var(--transition-fast);
        }
        .search-options .toggle-label-text:hover { color: var(--text-main); }
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--ai-bg); border: 1px solid var(--border);
            transition: .4s; border-radius: 12px;
        }
        .slider:before {
            position: absolute; content: ""; height: 16px; width: 16px;
            left: 3px; bottom: 3px; background-color: var(--text-secondary);
            transition: .4s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary); border-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); background-color: white; }

        /* ğŸŒŸ NEW: Sort Controls Styling */
        .sort-controls {
            display: flex; align-items: center; gap: 10px; margin-bottom: 20px;
        }
        #sort-by-select {
            flex-grow: 1; background: var(--card-bg); color: var(--text-main);
            border: 2px solid var(--border); border-radius: var(--radius-md); padding: 10px 15px;
            font-family: var(--font-main); font-size: 0.9em; font-weight: 600; outline: none;
            transition: all var(--transition-med); cursor: pointer; -webkit-appearance: none; -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23a0a0b0'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: left 15px center; background-size: 1.2em;
            padding-left: 40px;
        }
        body.light-mode #sort-by-select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%235A5A5A'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
        }
        #sort-by-select:focus {
            border-color: var(--secondary); box-shadow: 0 0 0 4px rgba(240, 165, 0, 0.2);
        }
        #sort-direction-btn {
            font-size: 1.4rem; flex-shrink: 0; padding: 8px; border: 2px solid var(--border);
            background: var(--card-bg); line-height: 1;
        }
        #sort-direction-btn:hover {
            color: var(--primary); border-color: var(--primary); transform: scale(1.05);
        }

        /* Conversation List (OmniView Style) */
        #conversation-list-container { padding: 0 10px; }
        .category-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; margin: 8px 0 4px; cursor: pointer; border-radius: var(--radius-md); background: rgba(128,128,128,0.08); transition: var(--transition-fast); font-weight: bold; }
        .category-header:hover { background: var(--secondary); color: #111; }
        .category-title { display: flex; align-items: center; gap: 10px; }
        .category-count { font-size: 0.8em; opacity: 0.7; }
        .category-toggle-icon { transition: transform var(--transition-med); }
        .category-header.collapsed .category-toggle-icon { transform: rotate(-90deg); }

        .conversation-group { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 4px; overflow: hidden; transition: max-height 0.4s ease-out; }
        .conversation-group.collapsed { max-height: 0 !important; }
        .conversation-group li {
            padding: 10px 15px; margin: 0 5px; cursor: pointer; border-radius: var(--radius-sm); transition: all var(--transition-fast);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 700; position: relative; color: var(--text-secondary);
        }
        .conversation-group li::before { content: ''; position: absolute; top: 0; right: 0; height: 100%; width: 4px; background-color: var(--secondary); transform: scaleY(0); transition: transform 0.3s ease; transform-origin: bottom; border-radius: 0 4px 4px 0; }
        .conversation-group li:hover { background-color: rgba(128,128,128,0.08); color: var(--text-main); transform: translateX(-2px); }
        .conversation-group li:hover::before { transform: scaleY(1); transform-origin: top; }
        .conversation-group li.active { background: linear-gradient(95deg, var(--primary) 0%, #a52929 100%); color: white; font-weight: bold; border-color: transparent; }
        .conversation-group li.active:hover { filter: brightness(1.1); }
        .conversation-group li.hidden { display: none; }

        /* Right Sidebar: Conversation Analysis */
        .info-card { background-color: var(--card-bg); border-radius: var(--radius-md); padding: 15px; margin-bottom: 20px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); }
        .info-card p { display: flex; justify-content: space-between; font-size: 0.95em; color: var(--text-secondary); margin-bottom: 8px; }
        .info-card span { font-weight: bold; color: var(--text-main); }
        #top-words-list { list-style: none; display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        #top-words-list li { background-color: var(--ai-bg); color: var(--text-secondary); padding: 4px 10px; border-radius: var(--radius-sm); font-size: 0.85em; font-family: var(--font-code); }
        #downloadButton { width: 100%; font-weight: bold; color: white; padding: 12px; border-radius: var(--radius-md); background: #008f82; transition: var(--transition-fast); border:none; cursor:pointer;}
        #downloadButton:hover { filter: brightness(1.2); box-shadow: 0 3px 10px rgba(0,213,195,0.2); transform: translateY(-2px); }

        /* ========================================================
           --- ğŸ“œ || CODEX WORKSPACE: THE MAIN DISPLAY || ğŸ“œ ---
           ======================================================== */
        #main-workspace {
            grid-area: main-workspace; display: flex; flex-direction: column; overflow: hidden; background: var(--main-bg);
            border-right: 1px solid var(--border); border-left: 1px solid var(--border);
        }
        #chat-header {
            padding: 18px 35px; border-bottom: 1px solid var(--border); flex-shrink: 0; z-index: 50;
            display: flex; justify-content: space-between; align-items: center; background-color: var(--card-bg);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        #chat-header h2 { margin: 0; font-size: 1.8rem; font-weight: 900; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #editCategoryBtn {
            font-size: 1em; color: var(--text-secondary); font-weight: 600; background-color: var(--ai-bg); padding: 8px 15px;
            border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-fast);
            display: flex; align-items: center; gap: 8px; flex-shrink: 0; border: none; white-space: nowrap;
        }
        #editCategoryBtn:hover { background-color: var(--secondary); color: #111; transform: translateY(-2px); box-shadow: 0 3px 8px var(--shadow-color); }

        #message-container { flex-grow: 1; overflow-y: auto; padding: 35px 40px; display: flex; flex-direction: column; gap: 28px; }
        
        /* Message Bubbles & Animation (OmniView Polish) */
        .message { padding: 16px 24px; border-radius: var(--radius-lg); max-width: 85%; word-wrap: break-word; font-size: 1.05rem; opacity: 0; animation: messageReveal 0.6s var(--transition-med) forwards; box-shadow: 0 3px 6px rgba(0,0,0,0.2); transition: all var(--transition-fast); }
        @keyframes messageReveal { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .user-message { background: var(--user-bg); color: var(--user-text); align-self: flex-end; border-bottom-left-radius: var(--radius-sm); }
        .ai-message { background: var(--ai-bg); color: var(--ai-text); align-self: flex-start; border-bottom-right-radius: var(--radius-sm); }

        /* Initial Welcome View */
        #initial-view { text-align: center; color: var(--text-secondary); margin: auto; padding: 20px; }
        #initial-view i { font-size: 5rem; display: block; margin-bottom: 20px; color: var(--primary); animation: pulseDragon 3s infinite ease-in-out; }
        @keyframes pulseDragon { 0%, 100% { transform: scale(1); text-shadow: none; } 50% { transform: scale(1.1); text-shadow: 0 0 15px var(--primary); } }
        #initial-view h2 { font-size: 2.2em; font-weight: 900; margin-bottom: 10px; color: var(--text-main); }
        
        /* --- Superior Markdown Styling (from OmniView, Re-themed) --- */
        .message-content { margin-top: 5px; line-height: 1.8; }
        .message-content > *:first-child { margin-top: 0; } .message-content > *:last-child { margin-bottom: 0; }
        .message-content p { margin-bottom: 1em; }
        .message-content h1, .message-content h2, .message-content h3 { margin: 1.8em 0 1.1em; padding-bottom: 0.4em; border-bottom: 2px solid var(--border); font-weight: 900; }
        .message-content h1 { font-size: 1.9em; color: var(--primary); } .message-content h2 { font-size: 1.6em; } .message-content h3 { font-size: 1.4em; }
        .message-content ul, .message-content ol { margin-bottom: 1.1em; padding-right: 35px; }
        .message-content li { margin-bottom: 0.7em; } .message-content li::marker { color: var(--secondary); font-weight: bold; }
        .message-content blockquote { border-right: 6px solid var(--secondary); background-color: rgba(240, 165, 0, 0.05); padding: 16px 28px 16px 12px; margin: 1.6em 0; border-radius: 0 var(--radius-md) var(--radius-md) 0; border-left: none; }
        .message-content pre { position: relative; background-color: var(--code-bg); color: var(--code-text); border: 1px solid var(--code-border); border-radius: var(--radius-md); padding: 20px 22px; margin: 1.6em 0; overflow-x: auto; font-family: var(--font-code); direction: ltr; text-align: left; box-shadow: inset 0 2px 8px rgba(0,0,0,0.4); }
        .message-content code:not(pre code) { font-family: var(--font-code); font-size: 0.9em; background-color: var(--code-bg); padding: 0.35em 0.8em; border-radius: var(--radius-sm); border: 1px solid var(--code-border); color: var(--secondary); }
        .message-content pre code { background: none; padding: 0; border: none; font-size: inherit; }
        .code-copy-button { position: absolute; top: 12px; left: 12px; background: rgba(128,128,128,0.2); color: var(--text-secondary); border: 1px solid var(--code-border); padding: 5px 10px; border-radius: var(--radius-sm); cursor: pointer; opacity: 0; transition: var(--transition-fast); }
        .message-content pre:hover .code-copy-button { opacity: 1; }
        .code-copy-button.copied { background: #008f82; color: white; border-color: transparent;}
        .message-content table { border-collapse: separate; border-spacing: 0; margin: 2em 0; width: 100%; border: 1px solid var(--border); border-radius: var(--radius-md); overflow: hidden; }
        .message-content th, .message-content td { padding: 15px 20px; text-align: right; border-bottom: 1px solid var(--border); }
        .message-content td { border-right: 1px solid var(--border); } .message-content td:first-child { border-right: none; }
        .message-content th { background-color: var(--ai-bg); font-weight: 800; color: var(--text-secondary); font-size: 0.9em; }
        .message-content a { color: var(--primary); text-decoration: none; font-weight: 700; border-bottom: 2px dotted currentColor; transition: color var(--transition-fast), border-color 0.2s ease; padding-bottom: 2px; }
        .message-content a:hover { color: var(--secondary); border-bottom-style: solid; }

        /* Category Edit Modal (OmniView Style) */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: var(--transition-med); }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: var(--card-bg); border: 1px solid var(--border); padding: 30px; border-radius: var(--radius-lg); box-shadow: 0 10px 50px rgba(0,0,0,0.5); width: 90%; max-width: 500px; transform: scale(0.95) translateY(-20px); transition: transform var(--transition-med); }
        .modal-overlay.visible .modal-content { transform: scale(1) translateY(0); }
        .modal-content h3 { color: var(--secondary); margin-top: 0; margin-bottom: 20px; font-size: 1.6em; }
        .modal-category-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid var(--border); border-radius: var(--radius-md); background: var(--main-bg); color: var(--text-main); font-family: var(--font-main); outline: none; transition: var(--transition-fast); }
        .modal-category-input:focus { border-color: var(--secondary); }
        .modal-category-list { max-height: 250px; overflow-y: auto; border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 20px; }
        .modal-category-list div { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border); transition: var(--transition-fast); font-weight: 600; }
        .modal-category-list div:last-child { border-bottom: none; }
        .modal-category-list div:hover { background: var(--ai-bg); }
        .modal-category-list div.selected { background: var(--secondary); color: #111; font-weight: bold; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
        .modal-btn { padding: 10px 20px; border-radius: var(--radius-md); font-weight: bold; border: none; cursor: pointer; transition: var(--transition-fast); }
        .modal-btn.confirm { background: var(--primary); color: white; }
        .modal-btn.confirm:hover { filter: brightness(1.2); }
        .modal-btn.cancel { background: var(--ai-bg); color: var(--text-secondary); }

        /* Notification Toast (OmniView Style) */
        #notification-toast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background: var(--card-bg); color: var(--text-main); padding: 15px 25px; border-radius: var(--radius-lg); box-shadow: 0 5px 20px rgba(0,0,0,0.4); z-index: 2000; transition: all 0.5s ease-in-out; display: flex; align-items: center; gap: 10px; font-weight: 600; border: 1px solid var(--border); }
        #notification-toast.show { bottom: 30px; opacity: 1; transform: translateX(-50%) translateY(0); }
        #notification-toast span:first-child { font-size: 1.2em; }

        /* --- ğŸ“± || Responsive Design || ğŸ“± --- */
        @media (max-width: 1200px) { .omni-archive-app { grid-template-columns: 280px 1fr 280px; } }
        @media (max-width: 992px) {
            .omni-archive-app { grid-template-columns: 1fr; grid-template-rows: auto 1fr; grid-template-areas: "header" "main-workspace"; }
            .sidebar { position: fixed; top: 0; height: 100%; width: 320px; max-width: 90%; z-index: 100; transform: translateX(100%); transition: transform var(--transition-med); box-shadow: -10px 0 30px rgba(0,0,0,0.3); border-left: 1px solid var(--border); }
            #sidebar-left { right: 0; }
            #sidebar-right { right: 0; }
            .sidebar.visible { transform: translateX(0); }
            body.sidebar-open::after { content: ''; position: fixed; inset: 0; background: rgba(0,0,0,0.5); -webkit-backdrop-filter: blur(5px); backdrop-filter: blur(5px); z-index: 99; opacity: 1; transition: opacity var(--transition-med); }
            .message { max-width: 95%; }
            #chat-header h2 { font-size: 1.6em; }
            #breadcrumbs { display: none; }
        }
    </style>
</head>
<body class="dark-mode">

    <div class="omni-archive-app">
        <!-- ğŸ”ï¸ HEADER -->
        <header class="app-header">
            <div class="header-controls">
                <button class="control-btn" id="toggle-left-sidebar" title="ÙØªØ­ Ø§Ù„Ø£Ø±Ø´ÙŠÙ"><i class="fa-solid fa-folder-tree"></i></button>
            </div>
            <div id="breadcrumbs">
                 <!-- Populated by JS -->
            </div>
            <div class="header-controls">
                <button class="control-btn" id="toggle-right-sidebar" title="ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„"><i class="fa-solid fa-chart-simple"></i></button>
                <button class="control-btn" id="darkModeToggle" title="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­"><i class="fas fa-sun"></i></button>
            </div>
        </header>

        <!-- ğŸ—‚ï¸ SIDEBAR LEFT -->
        <aside class="sidebar" id="sidebar-left">
            <div class="sidebar-section">
                <h3><i class="fa-solid fa-upload"></i> Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª</h3>
                 <div class="input-container">
                     <label for="fileInput" class="file-input-label json">
                         <i class="fa-solid fa-file-code"></i>&nbsp; Ù…Ù„Ù (ChatGPT / DeepSeek)
                     </label>
                     <input type="file" id="fileInput" accept=".json">
                     
                     <label for="folderInput" class="file-input-label folder">
                         <i class="fa-solid fa-folder"></i>&nbsp; Ù…Ø¬Ù„Ø¯ (AI Studio)
                     </label>
                     <input type="file" id="folderInput" webkitdirectory directory multiple>
                 </div>
                 <div id="search-container">
                    <input type="search" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø£Ùˆ Ø§Ù„Ù…Ø­ØªÙˆÙ‰...">
                    <i id="search-icon" class="fa-solid fa-magnifying-glass"></i>
                </div>
                <div class="search-options">
                    <label class="toggle-switch">
                        <input type="checkbox" id="searchContentToggle">
                        <span class="slider"></span>
                    </label>
                    <label for="searchContentToggle" class="toggle-label-text">ğŸ“œ Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰</label>
                </div>
                <!-- ğŸŒŸ NEW: Sort Controls -->
                <div class="sort-controls">
                    <select id="sort-by-select">
                        <option value="alphabetical">Ø£Ø¨Ø¬Ø¯ÙŠ</option>
                        <option value="date">Ø§Ù„Ø£Ø­Ø¯Ø«</option>
                        <option value="size">Ø§Ù„Ø£Ø¶Ø®Ù…</option>
                    </select>
                    <button id="sort-direction-btn" class="control-btn" title="ØªØºÙŠÙŠØ± Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØªØ±ØªÙŠØ¨">
                        <i class="fa-solid fa-arrow-down-a-z"></i>
                    </button>
                </div>
            </div>
            <div id="conversation-list-container">
                 <!-- Categories & conversations will be spawned here -->
            </div>
        </aside>

        <!-- ğŸ§© MAIN WORKSPACE -->
        <main id="main-workspace">
            <div id="chat-header">
                <h2 id="conversation-title-display">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø©</h2>
                <button id="editCategoryBtn" style="display: none;">
                    <span id="currentCategoryDisplay"></span>&nbsp;<i class="fa-solid fa-pen-to-square"></i>
                </button>
            </div>
            <div id="message-container">
                 <div id="initial-view">
                    <i class="fa-solid fa-dragon"></i>
                    <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ø®Ø·ÙˆØ·Ø© Ø§Ù„Ù†Ø§Ø±</h2>
                    <p>Ø£Ø·Ù„Ù‚ Ø§Ù„Ø¹Ù†Ø§Ù† Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø¨Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ù„ÙØ§ØªÙƒ Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠØ©.</p>
                </div>
            </div>
        </main>

        <!-- ğŸš€ SIDEBAR RIGHT -->
        <aside class="sidebar" id="sidebar-right">
            <div class="sidebar-section">
                <h3><i class="fa-solid fa-magnifying-glass-chart"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„</h3>
                <div class="info-card" id="conversation-meta">
                    <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: <span id="message-count">0</span></p>
                    <p>Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª: <span id="word-count">0</span></p>
                </div>
                
                <h3><i class="fa-solid fa-fire"></i> Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø´ØªØ¹Ø§Ù„Ø§Ù‹</h3>
                <div class="info-card">
                     <ul id="top-words-list"></ul>
                </div>

                <h3><i class="fa-solid fa-save"></i> Ø®ØªÙ… Ø§Ù„Ø°Ø§ÙƒØ±Ø©</h3>
                <button id="downloadButton"><i class="fa-solid fa-download"></i>&nbsp; Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            </div>
        </aside>
    </div>

    <!-- Modals and Toasts -->
    <div id="categoryEditModal" class="modal-overlay">
        <div class="modal-content">
            <h3>ØªØ¹Ø¯ÙŠÙ„ ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</h3>
            <input type="text" id="modalCategoryInput" class="modal-category-input" placeholder="Ø§ÙƒØªØ¨ ØªØµÙ†ÙŠÙ Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ø§Ø®ØªØ±...">
            <div class="modal-category-list" id="modalCategoryList"></div>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="cancelCategoryEdit">Ø¥Ù„ØºØ§Ø¡</button>
                <button class="modal-btn confirm" id="saveCategoryEdit">Ø­ÙØ¸</button>
            </div>
        </div>
    </div>

    <div id="notification-toast">
        <span class="toast-icon"></span> <span id="toast-message"></span>
    </div>

 <script>
    // =================================================================
    // --- ğŸ§  || THE ARCHIVIST'S MIND: UNIFIED JAVASCRIPT LOGIC || ğŸ§  ---
    // =================================================================
    document.addEventListener('DOMContentLoaded', () => {

        // --- DOM Cache: All components of the archive ---
        const dom = {
            body: document.body, fileInput: document.getElementById('fileInput'), folderInput: document.getElementById('folderInput'),
            conversationListContainer: document.getElementById('conversation-list-container'), messageContainer: document.getElementById('message-container'),
            conversationTitleDisplay: document.getElementById('conversation-title-display'), initialView: document.getElementById('initial-view'),
            breadcrumbs: document.getElementById('breadcrumbs'), wordCountDisplay: document.getElementById('word-count'), messageCountDisplay: document.getElementById('message-count'),
            topWordsList: document.getElementById('top-words-list'), darkModeToggle: document.getElementById('darkModeToggle'),
            toggleLeftSidebar: document.getElementById('toggle-left-sidebar'), toggleRightSidebar: document.getElementById('toggle-right-sidebar'),
            sidebarLeft: document.getElementById('sidebar-left'), sidebarRight: document.getElementById('sidebar-right'),
            searchInput: document.getElementById('searchInput'),
            searchContentToggle: document.getElementById('searchContentToggle'),
            downloadButton: document.getElementById('downloadButton'),
            editCategoryBtn: document.getElementById('editCategoryBtn'), currentCategoryDisplay: document.getElementById('currentCategoryDisplay'),
            categoryEditModal: document.getElementById('categoryEditModal'), modalCategoryInput: document.getElementById('modalCategoryInput'),
            modalCategoryList: document.getElementById('modalCategoryList'), cancelCategoryEditBtn: document.getElementById('cancelCategoryEdit'),
            saveCategoryEditBtn: document.getElementById('saveCategoryEdit'), notificationToast: document.getElementById('notification-toast'),
            toastMessage: document.getElementById('toast-message'), toastIcon: document.querySelector('#notification-toast .toast-icon'),
            // ğŸŒŸ NEW: Sort control elements
            sortBySelect: document.getElementById('sort-by-select'),
            sortDirectionBtn: document.getElementById('sort-direction-btn'),
        };

        // --- State Management ---
        let allConversations = [];
        let activeConversationIndex = -1;
        let activeListItem = null;
        // ğŸŒŸ NEW: State for sorting
        let currentSort = {
            by: 'alphabetical', // 'alphabetical', 'date', 'size'
            direction: 'asc'     // 'asc', 'desc'
        };


        // --- Constants & Config ---
        const STOP_WORDS = new Set(['ÙÙŠ','Ù…Ù†','Ø¹Ù„Ù‰','Ùˆ','ÙŠØ§','Ù‡Ùˆ','Ù‡ÙŠ','Ø£Ù†Ø§','Ø§Ù†Øª','Ø¥Ù„Ù‰','Ø¹Ù†','ØªÙ…','Ù‚Ø¯','Ø£Ù†','Ù‡Ø°Ø§','Ù‡Ø°Ù‡','Ø°Ù„Ùƒ','Ù…Ø¹','ÙƒÙ„','ÙŠÙƒÙˆÙ†','ÙƒØ§Ù†','Ù„Ø§','Ù…Ø§','Ù„Ùˆ','Ø¨Ø³','ÙŠØ¹Ù†ÙŠ','Ø£Ùˆ','Ø§Ù„Ù„ÙŠ','Ø¯Ù‡','Ø¯ÙŠ','ÙÙŠÙ‡','Ø¬Ø¯Ø§','Ø·ÙŠØ¨','ØªÙ…Ø§Ù…','Ø¥ÙŠÙ‡','Ø²ÙŠ','Ù…Ø´','Ø§Ù‡','the','a','an','is','are','was','were','in','on','at','of','to','for','with','by','and','or','but','if','you','i','me','my','he','she','it','we','they','that','this','what','which','who','when','where','why','how','can','will','do','does','did','not','so','be','just','very','also','Ù„ÙƒÙ†','Ù‡Ù„','ÙƒÙŠÙ','Ù…ØªÙ‰','Ø£ÙŠÙ†','Ù„Ù…Ø§Ø°Ø§','Ø¹Ù†Ø¯ÙŠ','Ø¹Ù†Ø¯Ùƒ','Ù„Ø¯Ù‰']);
        const USER_IDENTIFIERS = ['user', 'Ø£Ù†Ø§', 'Ø£Ù†Øª'];
        const categoryIcons = {"PROJECT_DRAGON":"ğŸ‰","AI_and_ML":"ğŸ§ ","Programming":"ğŸ’»","Cybersecurity":"ğŸ”’","Business_and_Startups":"ğŸ’¼","Hardware_and_OS":"ğŸ–¥ï¸","Design_and_Content":"ğŸ¨","Personal_Development":"âœ¨","Philosophy_and_Life":"ğŸ’¡","Religion_and_Spirituality":"ğŸ•Œ","Personal_and_Supportive":"â¤ï¸","Miscellaneous":"â“","Empty_Chat":"ğŸ‘»","Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ":"ğŸ“","Uncategorized":"ğŸ“",};
        
        // --- Initialization ---
        initializeTheme();
        bindEventListeners();
        resetUIOnLaunch();
        
        // ============================
        // --- Event Listener Binding ---
        // ============================
        function bindEventListeners() {
            dom.fileInput.addEventListener('change', handleFileSelect);
            dom.folderInput.addEventListener('change', handleFolderSelect);
            dom.darkModeToggle.addEventListener('click', toggleDarkMode);
            dom.toggleLeftSidebar.addEventListener('click', () => toggleSidebar(dom.sidebarLeft));
            dom.toggleRightSidebar.addEventListener('click', () => toggleSidebar(dom.sidebarRight));
            dom.searchInput.addEventListener('input', filterAndRenderConversationList);
            dom.searchContentToggle.addEventListener('change', filterAndRenderConversationList);
            dom.downloadButton.addEventListener('click', downloadConversations);
            dom.editCategoryBtn.addEventListener('click', openCategoryEditModal);
            dom.cancelCategoryEditBtn.addEventListener('click', closeCategoryEditModal);
            dom.saveCategoryEditBtn.addEventListener('click', saveCategoryChange);
            dom.modalCategoryInput.addEventListener('input', () => populateModalCategoryList(dom.modalCategoryInput.value));
            
            // ğŸŒŸ NEW: Sort control listeners
            dom.sortBySelect.addEventListener('change', handleSortChange);
            dom.sortDirectionBtn.addEventListener('click', handleSortDirectionChange);
            
            dom.categoryEditModal.addEventListener('click', (e) => { if (e.target === dom.categoryEditModal) closeCategoryEditModal(); });
            document.addEventListener('click', (event) => {
                if (!dom.body.classList.contains('sidebar-open')) return;
                const visibleSidebar = document.querySelector('.sidebar.visible');
                if (visibleSidebar && !visibleSidebar.contains(event.target) && !event.target.closest('button[id^="toggle-"]')) {
                    toggleSidebar(visibleSidebar, false);
                }
            });

            updateSortDirectionIcon(); // Set initial sort icon
        }
        
        // ========================================================
        // --- ğŸŒŸ MODIFIED: Universal Data Transformation Engine
        // ========================================================
        function transformChatGPTData(rawData) {
            return rawData.map(convoData => {
                const messages = [];
                const mapping = convoData.mapping;
                if (!mapping) return { title: convoData.title, messages: [], lastModified: null };
                let rootNode = Object.values(mapping).find(node => node.parent === null);
                if (!rootNode) return { title: convoData.title, messages: [], lastModified: null };
                let currentNodeId = rootNode.children.length > 0 ? rootNode.children[0] : null;
                while (currentNodeId) {
                    const node = mapping[currentNodeId];
                    if (!node || !node.message) break;
                    const role = node.message.author?.role;
                    const contentParts = node.message.content?.parts;
                    if ((role === 'user' || role === 'assistant') && contentParts && contentParts.join('').trim() !== '') {
                        messages.push({ author: role === 'user' ? 'user' : 'ChatGPT', content: contentParts.join('\n') });
                    }
                    currentNodeId = node.children.length > 0 ? node.children[0] : null;
                }
                return { title: convoData.title, messages: messages, lastModified: null };
            });
        }

        function transformDeepSeekData(rawData) {
            return rawData.map((convo, index) => {
                    const newConvo = { title: convo.title || `Ø¥Ø´Ø§Ø±Ø© DeepSeek #${index + 1}`, messages: [], lastModified: null };
                    const mapping = convo.mapping;
                    if (!mapping || !mapping.root || !mapping.root.children) return newConvo;
                    let currentNodeId = mapping.root.children[0];
                    let isUserTurn = true; 
                    while (currentNodeId) {
                        const messageNode = mapping[currentNodeId];
                        if (messageNode && messageNode.message && typeof messageNode.message.content === 'string') {
                            newConvo.messages.push({ author: isUserTurn ? 'user' : 'DeepSeek', content: messageNode.message.content });
                            isUserTurn = !isUserTurn;
                        }
                        currentNodeId = messageNode && messageNode.children.length > 0 ? messageNode.children[0] : null;
                    }
                    return newConvo;
                });
        }

        function transformAiStudioData(fileName, content, lastModified = null) {
            const data = JSON.parse(content);
            if (!data.chunkedPrompt || !Array.isArray(data.chunkedPrompt.chunks)) return null;
            const messages = data.chunkedPrompt.chunks
                .filter(chunk => chunk.role && chunk.text && !chunk.isThought)
                .map(chunk => ({ author: chunk.role === 'user' ? 'user' : 'AI Studio', content: chunk.text }));
            return { title: fileName.replace('.json', ''), messages: messages, lastModified: lastModified };
        }

        function detectAndProcessFileContent(content) {
            try {
                const data = JSON.parse(content);
                if (!Array.isArray(data) || data.length === 0) {
                     throw new Error("Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ù…Ø­Ø§Ø¯Ø«Ø§Øª ØµØ§Ù„Ø­Ø©. Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù…Ù„Ù AI Studio Ù…Ù†ÙØ±Ø¯Ù‹Ø§.");
                }

                let transformedData;
                if (data[0].mapping && data[0].mapping.root) {
                    showToast("ğŸ§¬ ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø¥Ø´Ø§Ø±Ø© DeepSeek...");
                    transformedData = transformDeepSeekData(data);
                } else if (data[0].mapping) {
                    showToast("ğŸ¤– ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø¥Ø´Ø§Ø±Ø© ChatGPT...");
                    transformedData = transformChatGPTData(data);
                } else if (data[0].messages) {
                    showToast("ğŸ“œ ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø±Ø´ÙŠÙ...");
                    transformedData = data;
                } else {
                    throw new Error("Ø¨Ù†ÙŠØ© Ù…Ù„Ù JSON ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©. Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ØµØ¯Ø±.");
                }
                processAllConversations(transformedData);
            } catch (e) {
                 try {
                    // ğŸŒŸ MODIFIED: Pass current timestamp for single file imports
                    const singleConvo = transformAiStudioData("Imported File", content, Date.now());
                    if (singleConvo) {
                        showToast("âœ¨ ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø¥Ø´Ø§Ø±Ø© AI Studio...");
                        processAllConversations([singleConvo]);
                    } else {
                        throw new Error("ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù„Ù ÙƒÙ…ØµÙÙˆÙØ© ÙˆÙƒÙƒØ§Ø¦Ù† Ù…Ù†ÙØ±Ø¯.");
                    }
                } catch (finalError) {
                    handleFileReadError(finalError);
                }
            }
        }

        // ===================================
        // --- Core Application Logic ---
        // ===================================
        function handleFileSelect(event) {
            const file = event.target.files[0]; if (!file) return; resetUIForLoad();
            const reader = new FileReader();
            reader.onload = (e) => detectAndProcessFileContent(e.target.result);
            reader.onerror = (err) => handleFileReadError(err);
            reader.readAsText(file);
        }

        async function handleFolderSelect(event) {
            const files = event.target.files; if (!files || files.length === 0) return; resetUIForLoad();
            showToast(`âœ¨ Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ${files.length} Ø°Ø§ÙƒØ±Ø© Ù…Ù† AI Studio...`);
            // ğŸŒŸ MODIFIED: Pass file's lastModified timestamp
            const promises = Array.from(files).map(file => {
                 if (file.name.endsWith('.json') || !file.name.includes('.')) {
                    return file.text().then(content => ({ name: file.name, content, lastModified: file.lastModified }));
                 }
                 return Promise.resolve(null);
            });
            try {
                const fileContents = (await Promise.all(promises)).filter(Boolean);
                const transformedData = fileContents.map(file => { try { return transformAiStudioData(file.name, file.content, file.lastModified); } catch (e) { return null; }}).filter(Boolean);
                processAllConversations(transformedData);
            } catch(e) { handleFileReadError(e); }
        }

        function processAllConversations(data) {
            allConversations = data.map(convo => ({ 
                category: "Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ", 
                lastModified: null, // Ensure a default null value
                ...convo 
            }));
            
            requestAnimationFrame(() => {
                if (allConversations.length > 0) {
                    filterAndRenderConversationList(); // This renders the full list initially
                    dom.initialView.style.display = 'none';
                    const firstItem = dom.conversationListContainer.querySelector('li');
                    if (firstItem) firstItem.click();
                    showToast(`âœ… ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ${allConversations.length} Ø°Ø§ÙƒØ±Ø© Ø¨Ù†Ø¬Ø§Ø­.`, true);
                } else { handleFileReadError(new Error("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø­Ø§Ø¯Ø«Ø§Øª ØµØ§Ù„Ø­Ø©.")); }
            });
        }
        
        // --- ğŸŒŸ NEW: Sort Control Handlers ---
        function handleSortChange(event) {
            currentSort.by = event.target.value;
            // Set a logical default direction for the selected sort type
            if (currentSort.by === 'date' || currentSort.by === 'size') {
                currentSort.direction = 'desc'; // Default to newest/largest first
            } else {
                currentSort.direction = 'asc'; // Default to A-Z
            }
            updateSortDirectionIcon();
            filterAndRenderConversationList();
        }

        function handleSortDirectionChange() {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            updateSortDirectionIcon();
            filterAndRenderConversationList();
        }

        function updateSortDirectionIcon() {
            const icon = dom.sortDirectionBtn.querySelector('i');
            const isAsc = currentSort.direction === 'asc';
            let newIconClass = '';

            switch (currentSort.by) {
                case 'alphabetical':
                    newIconClass = isAsc ? 'fa-arrow-down-a-z' : 'fa-arrow-up-z-a';
                    break;
                case 'size': // Represents "Ø§Ù„Ø£Ø¶Ø®Ù…" (Largest) vs Smallest
                    newIconClass = isAsc ? 'fa-arrow-down-1-9' : 'fa-arrow-up-9-1';
                    break;
                case 'date': // Represents "Ø§Ù„Ø£Ø­Ø¯Ø«" (Newest) vs Oldest
                    newIconClass = isAsc ? 'fa-arrow-down-short-wide' : 'fa-arrow-up-wide-short';
                    break;
            }
            icon.className = `fa-solid ${newIconClass}`;
            dom.sortDirectionBtn.title = isAsc ? 'ØªØ±ØªÙŠØ¨ ØªØµØ§Ø¹Ø¯ÙŠ' : 'ØªØ±ØªÙŠØ¨ ØªÙ†Ø§Ø²Ù„ÙŠ';
        }

        // --- ğŸŒŸ MODIFIED: Search, Sort, and Render Function ---
        function filterAndRenderConversationList() {
            dom.conversationListContainer.innerHTML = '';
            if (allConversations.length === 0) return;

            const searchTerm = dom.searchInput.value.toLowerCase().trim();
            const searchInContent = dom.searchContentToggle.checked;

            let filteredConversations = searchTerm === ''
                ? allConversations.map((convo, index) => ({...convo, originalIndex: index}))
                : allConversations
                    .map((convo, index) => ({...convo, originalIndex: index}))
                    .filter(convo => {
                        const titleMatch = (convo.title || "").toLowerCase().includes(searchTerm);
                        if (titleMatch) return true;
                        if (searchInContent) {
                            return (convo.messages || []).some(msg => (msg.content || "").toLowerCase().includes(searchTerm));
                        }
                        return false;
                    });
            
            // --- Sorting Logic ---
            filteredConversations.sort((a, b) => {
                const dir = currentSort.direction === 'asc' ? 1 : -1;
                switch (currentSort.by) {
                    case 'date':
                        const dateA = a.lastModified;
                        const dateB = b.lastModified;
                        if (!dateA && dateB) return 1; // Push nulls to the bottom
                        if (dateA && !dateB) return -1;
                        if (!dateA && !dateB) return 0;
                        return (dateB - dateA) * dir; // Newest first is descending
                    case 'size':
                        return (b.messages.length - a.messages.length) * dir; // Largest first is descending
                    case 'alphabetical':
                    default:
                        return (a.title || '').localeCompare(b.title || '') * dir;
                }
            });

            const grouped = filteredConversations.reduce((acc, convo) => {
                const category = convo.category || 'Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ';
                if (!acc[category]) acc[category] = [];
                acc[category].push(convo);
                return acc;
            }, {});
            
            const sortedCategories = Object.keys(grouped).sort((a,b) => {
                if (a === 'Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ') return 1; if (b === 'Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ') return -1;
                return a.localeCompare(b);
            });
            const fragment = document.createDocumentFragment();

            sortedCategories.forEach(category => {
                const convos = grouped[category];
                const header = document.createElement('div');
                header.className = 'category-header';
                const icon = categoryIcons[category.replace(/\s/g, '_')] || 'ğŸ“';
                header.innerHTML = `<div class="category-title"><span>${icon}</span><span>${category}</span></div><div class="category-info"><span class="category-count">(${convos.length})</span><span class="category-toggle-icon"><i class="fas fa-chevron-down"></i></span></div>`;
                
                const ul = document.createElement('ul');
                ul.className = 'conversation-group';
                convos.forEach(({ title, originalIndex }) => {
                    const li = document.createElement('li');
                    li.textContent = title || `Ù…Ø­Ø§Ø¯Ø«Ø© ØºØ§Ù…Ø¶Ø© #${originalIndex + 1}`; li.dataset.index = originalIndex;
                    li.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (activeListItem) activeListItem.classList.remove('active');
                        li.classList.add('active'); activeListItem = li;
                        displayConversation(originalIndex);
                        if (window.innerWidth <= 992) toggleSidebar(dom.sidebarLeft, false);
                    });
                    ul.appendChild(li);
                });
                header.addEventListener('click', () => {
                    const listToToggle = header.nextElementSibling;
                    header.classList.toggle('collapsed'); listToToggle.classList.toggle('collapsed');
                    listToToggle.style.maxHeight = listToToggle.classList.contains('collapsed') ? '0px' : `${listToToggle.scrollHeight}px`;
                });
                fragment.appendChild(header);
                fragment.appendChild(ul);
            });
            dom.conversationListContainer.appendChild(fragment);

            dom.conversationListContainer.querySelectorAll('.conversation-group:not(.collapsed)').forEach(group => { group.style.maxHeight = `${group.scrollHeight}px`; });
            
             if(activeConversationIndex !== -1) {
                const currentLi = dom.conversationListContainer.querySelector(`li[data-index="${activeConversationIndex}"]`);
                if(currentLi) { currentLi.classList.add('active'); activeListItem = currentLi; }
            }
        }
        
        function displayConversation(index) {
            if (index < 0 || index >= allConversations.length) return;
            activeConversationIndex = index;
            const conversation = allConversations[index];
            
            dom.initialView.style.display = 'none';
            dom.editCategoryBtn.style.display = 'flex';
            dom.conversationTitleDisplay.textContent = conversation.title;
            dom.currentCategoryDisplay.textContent = conversation.category || 'Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ';
            dom.breadcrumbs.innerHTML = `<span class="breadcrumb-main"><i class="fa-solid fa-dragon"></i> Ù…Ø®Ø·ÙˆØ·Ø© Ø§Ù„Ù†Ø§Ø±</span> <i class="fa-solid fa-angle-right"></i> <span class="breadcrumb-category">${conversation.category}</span>`;
            
            dom.messageContainer.innerHTML = '';
            const fragment = document.createDocumentFragment();
            if (conversation.messages && conversation.messages.length > 0) {
                conversation.messages.forEach(msg => { if(msg && msg.content) fragment.appendChild(createMessageElement(msg)); });
            } else {
                const p = document.createElement('p'); p.textContent = 'Ù‡Ø°Ù‡ Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙØ§Ø±ØºØ©... Ø³ÙƒÙˆÙ† ØªØ§Ù….'; p.style.textAlign = 'center'; fragment.appendChild(p);
            }
            dom.messageContainer.appendChild(fragment);
            dom.messageContainer.scrollTop = 0;
            addCodeCopyButtons();
            analyzeAndDisplayMetadata(conversation);
        }
        
        function createMessageElement(msg) {
            const isUser = USER_IDENTIFIERS.includes(msg.author?.toLowerCase());
            const wrapper = document.createElement('div');
            wrapper.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
            
            const content = document.createElement('div');
            content.className = 'message-content';
            content.innerHTML = DOMPurify.sanitize(marked.parse(msg.content));
            
            wrapper.appendChild(content);
            return wrapper;
        }

        function analyzeAndDisplayMetadata(conversation) {
            const messages = conversation.messages || []; const fullText = messages.map(m => m.content).join(' '); const words = fullText.split(/\s+/).filter(Boolean);
            dom.messageCountDisplay.textContent = messages.length; dom.wordCountDisplay.textContent = words.length;
            const freqs = new Map();
            words.map(w => w.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"")).forEach(w => { if (w && !STOP_WORDS.has(w)) freqs.set(w, (freqs.get(w) || 0) + 1); });
            const topWords = Array.from(freqs.entries()).sort((a, b) => b[1] - a[1]).slice(0, 10);
            dom.topWordsList.innerHTML = '';
            topWords.forEach(([word, count]) => {
                const li = document.createElement('li'); li.textContent = `${word} (${count})`; dom.topWordsList.appendChild(li);
            });
        }
        
        function addCodeCopyButtons() {
            dom.messageContainer.querySelectorAll('pre').forEach(pre => {
                if (pre.querySelector('.code-copy-button')) return;
                const btn = document.createElement('button'); btn.className = 'code-copy-button'; btn.innerHTML = '<i class="fa-solid fa-copy"></i>';
                btn.addEventListener('click', () => {
                    navigator.clipboard.writeText(pre.querySelector('code').innerText).then(() => {
                        btn.classList.add('copied'); btn.innerHTML = '<i class="fa-solid fa-check"></i>';
                        setTimeout(() => { btn.classList.remove('copied'); btn.innerHTML = '<i class="fa-solid fa-copy"></i>'; }, 2000);
                    });
                });
                pre.appendChild(btn);
            });
        }
        
        // ============================
        // --- Components & UI Helpers ---
        // ============================
        let selectedCategoryForEdit = '';
        function openCategoryEditModal() {
            if (activeConversationIndex === -1) { showToast('âš ï¸ Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø© Ø£ÙˆÙ„Ø§Ù‹!', false); return; }
            const currentCategory = allConversations[activeConversationIndex].category || 'Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ';
            dom.modalCategoryInput.value = currentCategory;
            selectedCategoryForEdit = currentCategory;
            populateModalCategoryList();
            dom.categoryEditModal.classList.add('visible');
        }

        function populateModalCategoryList(filter = '') {
            dom.modalCategoryList.innerHTML = '';
            const unique = [...new Set(allConversations.map(c => c.category || 'Ø¨Ø¯ÙˆÙ† ØªØµÙ†ÙŠÙ'))].sort();
            unique.filter(c => c.toLowerCase().includes(filter.toLowerCase())).forEach(cat => {
                const div = document.createElement('div');
                div.textContent = cat;
                if (cat === selectedCategoryForEdit) div.classList.add('selected');
                div.addEventListener('click', () => {
                    dom.modalCategoryInput.value = cat;
                    dom.modalCategoryList.querySelectorAll('div').forEach(i => i.classList.remove('selected'));
                    div.classList.add('selected'); selectedCategoryForEdit = cat;
                });
                dom.modalCategoryList.appendChild(div);
            });
        }
        
        function saveCategoryChange() {
            if (activeConversationIndex === -1) return;
            const newCategory = dom.modalCategoryInput.value.trim();
            if (!newCategory) { showToast('âš ï¸ Ø§Ù„ØªØµÙ†ÙŠÙ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±ØºÙ‹Ø§!', false); return; }
            allConversations[activeConversationIndex].category = newCategory;
            
            filterAndRenderConversationList();
            
            dom.currentCategoryDisplay.textContent = newCategory;
            dom.breadcrumbs.querySelector('.breadcrumb-category').textContent = newCategory;
            
            closeCategoryEditModal();
            showToast(`âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØµÙ†ÙŠÙ Ø¥Ù„Ù‰ "${newCategory}"`);
        }
        function closeCategoryEditModal() { dom.categoryEditModal.classList.remove('visible'); }
        
        function downloadConversations() {
            if (allConversations.length === 0) { showToast('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø°ÙƒØ±ÙŠØ§Øª Ù„Ø­ÙØ¸Ù‡Ø§.', false); return; }
            const json = JSON.stringify(allConversations, null, 2); const blob = new Blob([json], { type: 'application/json' }); const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'Codex_Ignis_Export.json';
            a.click(); URL.revokeObjectURL(url);
            showToast('ğŸ“¥ ØªÙ… Ø®ØªÙ… Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
        }

        function resetUIForLoad() {
            dom.messageContainer.innerHTML = '<div></div>';
            dom.conversationTitleDisplay.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡...';
            dom.editCategoryBtn.style.display = 'none';
            activeConversationIndex = -1; activeListItem = null;
            resetAnalysisPane();
        }
        
        function resetUIOnLaunch() {
            resetUIForLoad();
            dom.conversationTitleDisplay.textContent = 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø±Ø­Ù„Ø©';
            dom.breadcrumbs.innerHTML = `<span class="breadcrumb-main"><i class="fa-solid fa-dragon"></i> Ù…Ø®Ø·ÙˆØ·Ø© Ø§Ù„Ù†Ø§Ø±</span>`;
            dom.messageContainer.innerHTML = ''; 
            dom.initialView.style.display = 'flex';
            dom.initialView.style.flexDirection = 'column';
            dom.initialView.style.justifyContent = 'center';
        }
        
        function resetAnalysisPane() {
            dom.messageCountDisplay.textContent = '0'; dom.wordCountDisplay.textContent = '0'; dom.topWordsList.innerHTML = '';
        }

        function toggleSidebar(sidebar, forceState) {
            const shouldBeVisible = forceState === undefined ? !sidebar.classList.contains('visible') : forceState;
            if (shouldBeVisible && window.innerWidth <= 992) {
                if (sidebar === dom.sidebarLeft && dom.sidebarRight.classList.contains('visible')) toggleSidebar(dom.sidebarRight, false);
                if (sidebar === dom.sidebarRight && dom.sidebarLeft.classList.contains('visible')) toggleSidebar(dom.sidebarLeft, false);
            }
            sidebar.classList.toggle('visible', shouldBeVisible);
            const anySidebarVisible = dom.sidebarLeft.classList.contains('visible') || dom.sidebarRight.classList.contains('visible');
            dom.body.classList.toggle('sidebar-open', anySidebarVisible);
        }
        
        function initializeTheme() { if (localStorage.getItem('theme') === 'light') toggleDarkMode(true); }

        function toggleDarkMode(forceLight = false) {
            const currentlyDark = dom.body.classList.contains('dark-mode');
            const turnLight = forceLight ? true : currentlyDark;

            dom.body.classList.toggle('dark-mode', !turnLight);
            dom.body.classList.toggle('light-mode', turnLight);
            dom.darkModeToggle.innerHTML = turnLight ? '<i class="fas fa-moon"></i>' : '<i class="fas fa-sun"></i>';
            dom.darkModeToggle.title = turnLight ? 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¸Ù„Ù…' : 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­';
            if(!forceLight) localStorage.setItem('theme', turnLight ? 'light' : 'dark');
        }

        let toastTimeout;
        function showToast(message, isSuccess = true) {
            clearTimeout(toastTimeout);
            dom.toastMessage.textContent = message;
            dom.toastIcon.innerHTML = isSuccess ? 'âœ…' : 'âš ï¸';
            dom.notificationToast.style.borderLeft = `4px solid ${isSuccess ? '#00c5a7' : 'var(--primary)'}`;
            dom.notificationToast.classList.add('show');
            toastTimeout = setTimeout(() => dom.notificationToast.classList.remove('show'), 3500);
        }

        function handleFileReadError(e) {
             showToast(`Ø®Ø·Ø£ ÙØ§Ø¯Ø­: ${e.message}`, false);
             resetUIOnLaunch();
        }
    });
</script>

</body>
</html>
